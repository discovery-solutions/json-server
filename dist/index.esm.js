import e from"path";import t from"fs";import{ObjectId as r,MongoClient as n}from"mongodb";import a from"buffer";import u from"os";import i from"http";import s from"jsonwebtoken";import o from"crypto";function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function f(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach((function(t){b(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function p(e){return p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},p(e)}function l(e,t,r,n,a,u,i){try{var s=e[u](i),o=s.value}catch(e){return void r(e)}s.done?t(o):Promise.resolve(o).then(n,a)}function h(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var u=e.apply(t,r);function i(e){l(u,n,a,i,s,"next",e)}function s(e){l(u,n,a,i,s,"throw",e)}i(void 0)}))}}function d(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function v(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function g(e,t,r){return t&&v(e.prototype,t),r&&v(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function b(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function m(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&S(e,t)}function y(e){return y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},y(e)}function S(e,t){return S=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},S(e,t)}function E(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function R(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return E(e)}function x(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=y(e);if(t){var a=y(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return R(this,r)}}function T(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==r)return;var n,a,u=[],i=!0,s=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(u.push(n.value),!t||u.length!==t);i=!0);}catch(e){s=!0,a=e}finally{try{i||null==r.return||r.return()}finally{if(s)throw a}}return u}(e,t)||k(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function k(e,t){if(e){if("string"==typeof e)return w(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?w(e,t):void 0}}function w(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function O(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=k(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var u,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,u=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw u}}}}var A={},N={public:!0},I=function(){function e(){var t=this;d(this,e),b(this,"run",function(){var e=h(regeneratorRuntime.mark((function e(t,r){var n,a,u,i,s,o,c;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,n=A[t.method],a=[],u=0===t.url.base?"/":t.url.base,e.t0=regeneratorRuntime.keys(n);case 5:if((e.t1=e.t0()).done){e.next=30;break}if(i=e.t1.value,u!==i){e.next=28;break}s=O(n[i]),e.prev=9,s.s();case 11:if((o=s.n()).done){e.next=20;break}return c=o.value.callback,e.t2=a,e.next=16,Promise.resolve(c(t,r)).catch(logger);case 16:e.t3=e.sent,e.t2.push.call(e.t2,e.t3);case 18:e.next=11;break;case 20:e.next=25;break;case 22:e.prev=22,e.t4=e.catch(9),s.e(e.t4);case 25:return e.prev=25,s.f(),e.finish(25);case 28:e.next=5;break;case 30:return e.abrupt("return",a.length>0&&!1===a.includes(!1));case 33:return e.prev=33,e.t5=e.catch(0),logger(e.t5),e.abrupt("return",!1);case 37:case"end":return e.stop()}}),e,null,[[0,33],[9,22,25,28]])})));return function(t,r){return e.apply(this,arguments)}}()),b(this,"getArgs",(function(e){var t=T(e,2);return{method:t[0],path:t[1],options:"object"===p(e[2])?e[2]:N,callback:"function"==typeof e[3]?e[3]:e[2]}})),b(this,"register",(function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];var a=t.getArgs(r),u=a.method,i=a.path,s=a.options,o=a.callback;void 0===A[u]&&(A[u]={}),!1===Array.isArray(A[u][i])&&(A[u][i]=[]),A[u][i].push({options:s,callback:o})})),b(this,"use",(function(){return t.register.apply(t,arguments)})),b(this,"get",(function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t.register.apply(t,[CONSTANTS.SERVER.METHODS.GET].concat(r))})),b(this,"post",(function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t.register.apply(t,[CONSTANTS.SERVER.METHODS.POST].concat(r))})),b(this,"patch",(function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t.register.apply(t,[CONSTANTS.SERVER.METHODS.PATCH].concat(r))})),b(this,"delete",(function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t.register.apply(t,[CONSTANTS.SERVER.METHODS.DELETE].concat(r))}))}return g(e,null,[{key:"getRequests",value:function(){var e=[];for(var t in A)for(var r in A[t])e.push({options:A[t][r][0].options,method:t,path:r});return e}},{key:"inWhitelist",value:function(t){return!!e.getRequests().find((function(e){return e.path===t.url.base&&e.method===t.method&&!1!==e.options.public}))}}]),e}(),D=function(){function r(n){var a=this;d(this,r),b(this,"writeFile",(function(e){return t.writeFileSync(a.filePath,JSON.stringify(e,null,2))})),b(this,"readFile",(function(){return t.existsSync(a.filePath)?JSON.parse(t.readFileSync(a.filePath,"utf8")):(t.writeFileSync(a.filePath,"{}"),{})})),b(this,"getAll",(function(){return a.db=a.readFile(),a.db[a.name][a.entity]})),b(this,"setAll",(function(e){a.db=e,a.writeFile(e)})),b(this,"add",(function(e){!1===Array.isArray(a.db[a.name][a.entity])&&(a.db[a.name][a.entity]=[]),a.db[a.name][a.entity].push(e),a.writeFile(a.db)})),b(this,"set",(function(e){a.db[a.name][a.entity]=e,a.writeFile(a.db)})),b(this,"find",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=a.getAll(),r=Object.keys(e),n=[];if(0===r.length)return t;var u,i=O(t);try{var s=function(){var t=u.value,a=[];r.forEach((function(r){t[r]===e[r]&&a.push(!0)})),a.length===r.length&&n.push(t)};for(i.s();!(u=i.n()).done;)s()}catch(e){i.e(e)}finally{i.f()}return n})),b(this,"indexOf",(function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=Object.keys(t),n=0,u=O(a.getAll());try{var i=function(){var a=e.value,u=[];if(r.forEach((function(e){a[e]===t[e]&&u.push(!0)})),u.length===r.length)return{v:n};n++};for(u.s();!(e=u.n()).done;){var s=i();if("object"===p(s))return s.v}}catch(e){u.e(e)}finally{u.f()}return-1})),this.filePath=e.join(process.cwd(),"db.json"),this.name=n,this.db=this.readFile()}return g(r,[{key:"setEntity",value:function(e){this.entity=e}}]),r}(),C=g((function e(){var t=this;d(this,e),b(this,"list",h(regeneratorRuntime.mark((function e(){var r,n,a,u,i=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=i.length>0&&void 0!==i[0]?i[0]:{},n=i.length>1&&void 0!==i[1]?i[1]:0,e.prev=2,a=t.storage.find(r),u=CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT+n,e.abrupt("return",a.slice(n,u));case 8:return e.prev=8,e.t0=e.catch(2),logger(e.t0),e.abrupt("return",!1);case 12:case"end":return e.stop()}}),e,null,[[2,8]])})))),b(this,"find",function(){var e=h(regeneratorRuntime.mark((function e(r){var n,a,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.storage.find(r);case 3:return n=e.sent,a=T(n,1),u=a[0],e.abrupt("return",u||!1);case 9:return e.prev=9,e.t0=e.catch(0),e.abrupt("return",!1);case 12:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(t){return e.apply(this,arguments)}}()),b(this,"findByID",function(){var e=h(regeneratorRuntime.mark((function e(r){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.find({id:r});case 3:if(e.t0=e.sent,e.t0){e.next=6;break}e.t0=!1;case 6:return e.abrupt("return",e.t0);case 9:return e.prev=9,e.t1=e.catch(0),e.abrupt("return",!1);case 12:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(t){return e.apply(this,arguments)}}()),b(this,"insert",function(){var e=h(regeneratorRuntime.mark((function e(n){var a,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=new Date,u=f({updated:a,created:a,id:r()},n),t.storage.add(u),e.abrupt("return",u);case 7:return e.prev=7,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",!1);case 11:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t){return e.apply(this,arguments)}}()),b(this,"insertMany",function(){var e=h(regeneratorRuntime.mark((function e(n){var a,u,i,s,o,c;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,a=new Date,u=[],i=O(n);try{for(i.s();!(s=i.n()).done;)o=s.value,c=f({updated:a,created:a,id:r()},o),t.storage.add(c),u.push(c)}catch(e){i.e(e)}finally{i.f()}return e.abrupt("return",u);case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",!1);case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t){return e.apply(this,arguments)}}()),b(this,"update",function(){var e=h(regeneratorRuntime.mark((function e(r,n){var a,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!((a=t.storage.indexOf(r))<0)){e.next=4;break}return e.abrupt("return",!1);case 4:return(u=t.storage.getAll())[a]=f(f({},u[a]),n),t.storage.set(u),e.abrupt("return",{modifiedCount:1});case 10:return e.prev=10,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",!1);case 14:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(t,r){return e.apply(this,arguments)}}()),b(this,"updateByID",function(){var e=h(regeneratorRuntime.mark((function e(r,n){var a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.update({id:r},n);case 3:return a=e.sent,e.abrupt("return",a);case 7:return e.prev=7,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",!1);case 11:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,r){return e.apply(this,arguments)}}()),b(this,"updateMany",function(){var e=h(regeneratorRuntime.mark((function e(t,r){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()),b(this,"delete",function(){var e=h(regeneratorRuntime.mark((function e(r){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.storage.find(r).map((function(e){return JSON.stringify(e)})),t.storage.set(t.storage.getAll().filter((function(e){return!n.includes(JSON.stringify(e))}))),e.abrupt("return",{deletedCount:n.length});case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),b(this,"deleteByID",function(){var e=h(regeneratorRuntime.mark((function e(r){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.delete({id:r});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),b(this,"deleteMany",function(){var e=h(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),b(this,"getLatest",function(){var e=h(regeneratorRuntime.mark((function e(r){var n,a,u,i=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:0,a=t.storage.find(r),u=CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT+n,e.abrupt("return",a.slice(n,u));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),b(this,"getOldest",function(){var e=h(regeneratorRuntime.mark((function e(r){var n,a,u,i=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:0,a=t.storage.find(r).reverse(),u=CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT+n,e.abrupt("return",a.slice(n,u));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())})),j=function(e){m(r,C);var t=x(r);function r(e){var n,a=e.name,u=e.key;return d(this,r),b(E(n=t.call(this)),"connect",h(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",E(n));case 1:case"end":return e.stop()}}),e)})))),b(E(n),"setEntity",function(){var e=h(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.entity=t,e.next=3,n.storage.setEntity(t);case 3:void 0===n.storage.db[n.name][n.entity]&&n.storage.set([]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),b(E(n),"count",h(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(null===(t=n.storage.db[n.name][n.entity])||void 0===t?void 0:t.length)||0);case 2:case"end":return e.stop()}}),e)})))),b(E(n),"validateID",function(){var e=h(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("string"==typeof t){e.next=2;break}return e.abrupt("return",!1);case 2:return e.abrupt("return",t.match(/^[0-9a-fA-F]{24}$/));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),n.storage=new D(a),n.storage.db[a]||(n.storage.db[a]={}),n.name=a,n.key=u,n.storage.setAll(f({},n.storage.db)),n}return g(r)}(),L={};function P(){return global["json-server"]||{}}function B(e){return void 0===e?[]:Array.isArray(e)?e:["string","number","boolean"].includes(p(e))||"object"===p(e)&&Object.keys(e).length>0?[e]:[]}function M(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e.id||e._id}function U(e){return F.apply(this,arguments)}function F(){return F=h(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Promise.resolve(t());case 3:return e.abrupt("return",e.sent);case 6:e.prev=6,e.t0=e.catch(0);case 8:case"end":return e.stop()}}),e,null,[[0,6]])}))),F.apply(this,arguments)}function V(e,t){var r=t.fields;if(!e||!r)return e;var n=Object.keys(r).filter((function(e){var t;return!0===(null===(t=r[e])||void 0===t?void 0:t.secure)}));return Object.keys(e).reduce((function(t,r){return!1===n.includes(r)&&(t[r]=e[r]),t}),{})}!function(e){var t=e,r=a.Buffer,n=u;t.toBuffer=function(e,t,n){var a;if(n=~~n,this.isV4Format(e))a=t||new r(n+4),e.split(/\./g).map((function(e){a[n++]=255&parseInt(e,10)}));else if(this.isV6Format(e)){var u,i=e.split(":",8);for(u=0;u<i.length;u++){var s;this.isV4Format(i[u])&&(s=this.toBuffer(i[u]),i[u]=s.slice(0,2).toString("hex")),s&&++u<8&&i.splice(u,0,s.slice(2,4).toString("hex"))}if(""===i[0])for(;i.length<8;)i.unshift("0");else if(""===i[i.length-1])for(;i.length<8;)i.push("0");else if(i.length<8){for(u=0;u<i.length&&""!==i[u];u++);var o=[u,1];for(u=9-i.length;u>0;u--)o.push("0");i.splice.apply(i,o)}for(a=t||new r(n+16),u=0;u<i.length;u++){var c=parseInt(i[u],16);a[n++]=c>>8&255,a[n++]=255&c}}if(!a)throw Error("Invalid ip address: "+e);return a},t.toString=function(e,t,r){t=~~t;var n=[];if(4===(r=r||e.length-t)){for(var a=0;a<r;a++)n.push(e[t+a]);n=n.join(".")}else if(16===r){for(a=0;a<r;a+=2)n.push(e.readUInt16BE(t+a).toString(16));n=(n=(n=n.join(":")).replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3")).replace(/:{3,4}/,"::")}return n};var i=/^(\d{1,3}\.){3,3}\d{1,3}$/,s=/^(::)?(((\d{1,3}\.){3}(\d{1,3}){1})?([0-9a-f]){0,4}:{0,2}){1,8}(::)?$/i;function o(e){return e?e.toLowerCase():"ipv4"}t.isV4Format=function(e){return i.test(e)},t.isV6Format=function(e){return s.test(e)},t.fromPrefixLen=function(e,n){var a=4;"ipv6"===(n=e>32?"ipv6":o(n))&&(a=16);for(var u=new r(a),i=0,s=u.length;i<s;++i){var c=8;e<8&&(c=e),e-=c,u[i]=255&~(255>>c)}return t.toString(u)},t.mask=function(e,n){e=t.toBuffer(e),n=t.toBuffer(n);var a=new r(Math.max(e.length,n.length)),u=0;if(e.length===n.length)for(u=0;u<e.length;u++)a[u]=e[u]&n[u];else if(4===n.length)for(u=0;u<n.length;u++)a[u]=e[e.length-4+u]&n[u];else{for(u=0;u<a.length-6;u++)a[u]=0;for(a[10]=255,a[11]=255,u=0;u<e.length;u++)a[u+12]=e[u]&n[u+12];u+=12}for(;u<a.length;u++)a[u]=0;return t.toString(a)},t.cidr=function(e){var r=e.split("/"),n=r[0];if(2!==r.length)throw new Error("invalid CIDR subnet: "+n);var a=t.fromPrefixLen(parseInt(r[1],10));return t.mask(n,a)},t.subnet=function(e,r){for(var n=t.toLong(t.mask(e,r)),a=t.toBuffer(r),u=0,i=0;i<a.length;i++)if(255===a[i])u+=8;else for(var s=255&a[i];s;)s=s<<1&255,u++;var o=Math.pow(2,32-u);return{networkAddress:t.fromLong(n),firstAddress:o<=2?t.fromLong(n):t.fromLong(n+1),lastAddress:o<=2?t.fromLong(n+o-1):t.fromLong(n+o-2),broadcastAddress:t.fromLong(n+o-1),subnetMask:r,subnetMaskLength:u,numHosts:o<=2?o:o-2,length:o,contains:function(e){return n===t.toLong(t.mask(e,r))}}},t.cidrSubnet=function(e){var r=e.split("/"),n=r[0];if(2!==r.length)throw new Error("invalid CIDR subnet: "+n);var a=t.fromPrefixLen(parseInt(r[1],10));return t.subnet(n,a)},t.not=function(e){for(var r=t.toBuffer(e),n=0;n<r.length;n++)r[n]=255^r[n];return t.toString(r)},t.or=function(e,r){if(e=t.toBuffer(e),r=t.toBuffer(r),e.length===r.length){for(var n=0;n<e.length;++n)e[n]|=r[n];return t.toString(e)}var a=e,u=r;r.length>e.length&&(a=r,u=e);var i=a.length-u.length;for(n=i;n<a.length;++n)a[n]|=u[n-i];return t.toString(a)},t.isEqual=function(e,r){if(e=t.toBuffer(e),r=t.toBuffer(r),e.length===r.length){for(var n=0;n<e.length;n++)if(e[n]!==r[n])return!1;return!0}if(4===r.length){var a=r;r=e,e=a}for(n=0;n<10;n++)if(0!==r[n])return!1;var u=r.readUInt16BE(10);if(0!==u&&65535!==u)return!1;for(n=0;n<4;n++)if(e[n]!==r[n+12])return!1;return!0},t.isPrivate=function(e){return/^(::f{4}:)?10\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(e)||/^(::f{4}:)?192\.168\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(e)||/^(::f{4}:)?172\.(1[6-9]|2\d|30|31)\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(e)||/^(::f{4}:)?127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(e)||/^(::f{4}:)?169\.254\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(e)||/^f[cd][0-9a-f]{2}:/i.test(e)||/^fe80:/i.test(e)||/^::1$/.test(e)||/^::$/.test(e)},t.isPublic=function(e){return!t.isPrivate(e)},t.isLoopback=function(e){return/^(::f{4}:)?127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})/.test(e)||/^fe80::1$/.test(e)||/^::1$/.test(e)||/^::$/.test(e)},t.loopback=function(e){if("ipv4"!==(e=o(e))&&"ipv6"!==e)throw new Error("family must be ipv4 or ipv6");return"ipv4"===e?"127.0.0.1":"fe80::1"},t.address=function(e,r){var a,u=n.networkInterfaces();if(r=o(r),e&&"private"!==e&&"public"!==e){var i=u[e].filter((function(e){return e.family.toLowerCase()===r}));if(0===i.length)return;return i[0].address}return(a=Object.keys(u).map((function(n){var a=u[n].filter((function(n){return n.family=n.family.toLowerCase(),n.family===r&&!t.isLoopback(n.address)&&(!e||("public"===e?t.isPrivate(n.address):t.isPublic(n.address)))}));return a.length?a[0].address:void 0})).filter(Boolean)).length?a[0]:t.loopback(r)},t.toLong=function(e){var t=0;return e.split(".").forEach((function(e){t<<=8,t+=parseInt(e)})),t>>>0},t.fromLong=function(e){return(e>>>24)+"."+(e>>16&255)+"."+(e>>8&255)+"."+(255&e)}}(L);var G=function(){function e(){d(this,e),this.entity=null,this.collection={}}var t,n,a,u,i,s,o,c,p,l,v,b,m,y;return g(e,[{key:"list",value:(y=h(regeneratorRuntime.mark((function e(){var t,r,n=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.length>0&&void 0!==n[0]?n[0]:{},r=n.length>1&&void 0!==n[1]?n[1]:0,e.prev=2,e.next=5,this.collection.find(t).limit(CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT).skip(r).sort({updated:-1}).toArray();case 5:return e.abrupt("return",e.sent);case 8:return e.prev=8,e.t0=e.catch(2),e.abrupt("return",!1);case 11:case"end":return e.stop()}}),e,this,[[2,8]])}))),function(){return y.apply(this,arguments)})},{key:"find",value:(m=h(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.collection.findOne(t);case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"findByID",value:(b=h(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.find({_id:r(t)});case 3:return n=e.sent,e.abrupt("return",n);case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",!1);case 10:case"end":return e.stop()}}),e,this,[[0,7]])}))),function(e){return b.apply(this,arguments)})},{key:"insert",value:(v=h(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=new Date,e.next=4,this.collection.insertOne(f({updated:r,created:r},t));case 4:return e.next=7,this.find(t);case 7:return e.abrupt("return",e.sent);case 10:return e.prev=10,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",!1);case 14:case"end":return e.stop()}}),e,this,[[0,10]])}))),function(e){return v.apply(this,arguments)})},{key:"insertMany",value:(l=h(regeneratorRuntime.mark((function e(t){var r,n,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=new Date,n=t.map((function(e){return f(f({},e),{},{updated:r,created:r})})),e.next=5,this.collection.insertMany(n);case 5:return a=e.sent,e.abrupt("return",a.ops);case 9:return e.prev=9,e.t0=e.catch(0),e.abrupt("return",!1);case 12:case"end":return e.stop()}}),e,this,[[0,9]])}))),function(e){return l.apply(this,arguments)})},{key:"updateByID",value:(p=h(regeneratorRuntime.mark((function e(t,n){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.update({_id:r(t)},n);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return p.apply(this,arguments)})},{key:"update",value:(c=h(regeneratorRuntime.mark((function e(t,r){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.collection.updateOne(t,{$set:f({updated:new Date},r)});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"updateMany",value:(o=h(regeneratorRuntime.mark((function e(t,r){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.collection.updateMany(t,{$set:f({updated:new Date},r)});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"delete",value:(s=h(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.collection.deleteOne(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"deleteByID",value:(i=h(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.delete({_id:r(t)});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"deleteMany",value:(u=h(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.collection.deleteMany(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"getLatest",value:(a=h(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.collection.find(t).limit(CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT).sort({$natural:-1}).toArray();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"getOldest",value:(n=h(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.collection.find(t).limit(CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT).sort({$natural:1}).toArray();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"search",value:(t=h(regeneratorRuntime.mark((function e(t){var r,n,a,u,i,s,o,c=this,f=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!(f.length>1&&void 0!==f[1])||f[1],n=P(),a=n.entities,u=[],i=O(a),e.prev=4,o=regeneratorRuntime.mark((function e(){var r,n,a,i,o,f,p;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=s.value,n=r.name,a=r.fields,i=c.db.collection(n),o=Object.keys(a).filter((function(e){var t,r;return[a[e],null===(t=a[e])||void 0===t?void 0:t.type].includes("string")&&!0!==(null===(r=a[e])||void 0===r?void 0:r.secure)})),f={$text:{$diacriticSensitive:!1,$caseSensitive:!1,$search:t}},"string"!=typeof t&&(f=o.reduce((function(e,r){return e[r]=t,e}),{})),e.next=7,i.find(f).toArray();case 7:(p=e.sent).length>0&&u.push(p.map((function(e){return{type:n,record:e}})));case 9:case"end":return e.stop()}}),e)})),i.s();case 7:if((s=i.n()).done){e.next=11;break}return e.delegateYield(o(),"t0",9);case 9:e.next=7;break;case 11:e.next=16;break;case 13:e.prev=13,e.t1=e.catch(4),i.e(e.t1);case 16:return e.prev=16,i.f(),e.finish(16);case 19:if(0!==u.length||!r){e.next=21;break}return e.abrupt("return",this.search(new RegExp(t,"gi"),!1));case 21:return e.abrupt("return",u.flat());case 22:case"end":return e.stop()}}),e,this,[[4,13,16,19]])}))),function(e){return t.apply(this,arguments)})}]),e}(),H=function(e){m(o,G);var t,r,a,u,i,s=x(o);function o(e){var t,r=e.uri,a=e.name,u=e.key;return d(this,o),(t=s.call(this)).client=new n(r),t.name=a,t.uri=r,t.key=u,t}return g(o,[{key:"createTextIndexes",value:(i=h(regeneratorRuntime.mark((function e(){var t,r,n,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=O(P().entities),e.prev=1,t.s();case 3:if((r=t.n()).done){e.next=15;break}return n=r.value,e.prev=5,a=this.db.collection(n.name),e.next=9,a.createIndex({"$**":"text"},{default_language:CONSTANTS.SERVER.SETTINGS.LANGUAGE.DEFAULT});case 9:e.next=13;break;case 11:e.prev=11,e.t0=e.catch(5);case 13:e.next=3;break;case 15:e.next=20;break;case 17:e.prev=17,e.t1=e.catch(1),t.e(e.t1);case 20:return e.prev=20,t.f(),e.finish(20);case 23:case"end":return e.stop()}}),e,this,[[1,17,20,23],[5,11]])}))),function(){return i.apply(this,arguments)})},{key:"connect",value:(u=h(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.client.connect();case 3:return this.db=this.client.db(this.name),e.next=6,this.createTextIndexes();case 6:return e.abrupt("return",this);case 9:return e.prev=9,e.t0=e.catch(0),console.log(e.t0),e.abrupt("return",e.t0);case 13:case"end":return e.stop()}}),e,this,[[0,9]])}))),function(){return u.apply(this,arguments)})},{key:"setEntity",value:(a=h(regeneratorRuntime.mark((function e(t){var r=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,U(h(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.db.createCollection(t);case 2:case"end":return e.stop()}}),e)}))));case 2:this.entity=t,this.collection=this.db.collection(t);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"count",value:(r=h(regeneratorRuntime.mark((function e(){var t,r=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.length>0&&void 0!==r[0]?r[0]:{},e.abrupt("return",this.collection.count(t));case 2:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"validateID",value:(t=h(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.match(/^[0-9a-fA-F]{24}$/));case 1:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})}]),o}(),q={},$=function(){function e(t){d(this,e),this.list=B(t.database),this.databases=q,0===this.list.length&&this.list.push({name:CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT,key:CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT,type:"custom"}),this.setup()}var t;return g(e,[{key:"setup",value:(t=h(regeneratorRuntime.mark((function e(){var t,r,n,a,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=O(this.list),e.prev=1,t.s();case 3:if((r=t.n()).done){e.next=19;break}return n=r.value,e.prev=5,a=this.getClassByType(n.type),u=new a(n),e.next=10,u.connect();case 10:this.databases[n.key]=u,e.next=17;break;case 13:e.prev=13,e.t0=e.catch(5),logger(e.t0),this.databases[n.key]=e.t0;case 17:e.next=3;break;case 19:e.next=24;break;case 21:e.prev=21,e.t1=e.catch(1),t.e(e.t1);case 24:return e.prev=24,t.f(),e.finish(24);case 27:0===Object.keys(this.databases).length&&logger("No databases connected");case 28:case"end":return e.stop()}}),e,this,[[1,21,24,27],[5,13]])}))),function(){return t.apply(this,arguments)})},{key:"getClassByType",value:function(e){switch(e){case"mongo-db":case"mongodb":case"mongoDB":case"mongo":return H;default:return j}}},{key:"getDB",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT;return this.databases[e]}}],[{key:"get",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT;return q[e]}},{key:"closeAll",value:function(e){var t=[];for(var r in q){var n,a;"function"==typeof(null===(n=q[r])||void 0===n||null===(a=n.client)||void 0===a?void 0:a.close)&&(q[r].client.close(),t.push(r))}return t}}]),e}(),_={REQUEST:{BEFORE:{RESPONSE:"REQUEST.BEFORE.RESPONSE",PROCESS:"REQUEST.BEFORE.PROCESS"}}},Q={},J=function(){function e(t){var r=this;return d(this,e),b(this,"run",h(regeneratorRuntime.mark((function e(){var t,n,a,u,i=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=Q[r.event],!1!==Array.isArray(t)){e.next=3;break}return e.abrupt("return",!1);case 3:n=O(t),e.prev=4,n.s();case 6:if((a=n.n()).done){e.next=22;break}return u=a.value,e.prev=8,e.next=11,Promise.resolve(u.apply(void 0,i));case 11:if(!1!==e.sent){e.next=14;break}return e.abrupt("return",!1);case 14:e.next=20;break;case 16:return e.prev=16,e.t0=e.catch(8),logger(e.t0),e.abrupt("return",!1);case 20:e.next=6;break;case 22:e.next=27;break;case 24:e.prev=24,e.t1=e.catch(4),n.e(e.t1);case 27:return e.prev=27,n.f(),e.finish(27);case 30:return e.abrupt("return",!0);case 31:case"end":return e.stop()}}),e,null,[[4,24,27,30],[8,16]])})))),this.event=t,!1===Array.isArray(Q[t])&&(Q[t]=[]),this}return g(e,[{key:"set",value:function(t){return e.setListener(this.event,t)}},{key:"remove",value:function(t){return e.removeListener(this.event,t)}}],[{key:"setListener",value:function(e,t){return Q[e].push(t)-1}},{key:"removeListener",value:function(e,t){try{Q[e].filter((function(e,r){return t!==r}));return!0}catch(e){return!1}}}]),e}();function Y(e,t){var r=t.fields,n=Object.keys(r).map((function(e){var t,n;return{type:(null===(t=r[e])||void 0===t?void 0:t.type)||p(r[e]),required:!(null===(n=r[e])||void 0===n||!n.required),key:e}})).filter((function(e){return e.required})).reduce((function(e,t){return t.required&&(e[t.key]=t.type),e}),{});for(var a in n)if(p(e[a])!==n[a])return!1;return!0}function W(e){return e.splitted[1]}var K=function(e,t){return function(r){var n=r.url.splitted.filter((function(e){return e.length>0}));return r.method===CONSTANTS.SERVER.METHODS[e]&&t(n.length)}},z={delete:K("DELETE",(function(e){return 2===e})),update:K("UPDATE",(function(e){return 2===e})),insert:K("INSERT",(function(e){return 1===e})),list:K("LIST",(function(e){return 1===e})),get:K("GET",(function(e){return 2===e})),oldest:function(e){return e.url.value.search("oldest")>-1&&e.method===CONSTANTS.SERVER.METHODS.GET},latest:function(e){return e.url.value.search("latest")>-1&&e.method===CONSTANTS.SERVER.METHODS.GET}},X=function(){function e(t,r){var n=this;d(this,e),b(this,"next",(function(e){return{response:n.response,code:e}})),b(this,"validateURL",h(regeneratorRuntime.mark((function e(){var t,r,a,u,i,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,t=P(),r=T(n.request.url.splitted,1),a=r[0],u=O(t.entities),e.prev=4,u.s();case 6:if((i=u.n()).done){e.next=16;break}if(s=i.value,!(a===s.name)){e.next=14;break}return n.entity=s,e.next=13,n.database.setEntity(s.name);case 13:return e.abrupt("return",200);case 14:e.next=6;break;case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(4),u.e(e.t0);case 21:return e.prev=21,u.f(),e.finish(21);case 24:return e.abrupt("return",404);case 27:return e.prev=27,e.t1=e.catch(0),logger(e.t1),e.abrupt("return",500);case 31:case"end":return e.stop()}}),e,null,[[0,27],[4,18,21,24]])})))),b(this,"action",h(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!z.oldest(n.request)){e.next=4;break}return e.next=3,n.oldest();case 3:case 7:case 11:case 15:case 19:case 23:case 27:return e.abrupt("return",e.sent);case 4:if(!z.latest(n.request)){e.next=8;break}return e.next=7,n.latest();case 8:if(!z.update(n.request)){e.next=12;break}return e.next=11,n.update();case 12:if(!z.delete(n.request)){e.next=16;break}return e.next=15,n.delete();case 16:if(!z.insert(n.request)){e.next=20;break}return e.next=19,n.insert();case 20:if(!z.list(n.request)){e.next=24;break}return e.next=23,n.list();case 24:if(!z.get(n.request)){e.next=28;break}return e.next=27,n.get();case 28:return e.abrupt("return",n.next(404));case 29:case"end":return e.stop()}}),e)})))),b(this,"list",h(regeneratorRuntime.mark((function e(){var t,r,a,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Promise.all([n.database.list(),n.database.count()]);case 3:return t=e.sent,r=T(t,2),a=r[0],u=r[1],n.response={records:a,count:u},e.abrupt("return",n.next(200));case 11:return e.prev=11,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",n.next(500));case 15:case"end":return e.stop()}}),e,null,[[0,11]])})))),b(this,"get",h(regeneratorRuntime.mark((function e(){var t,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=n.request.url.splitted[1]+"",!1!==n.database.validateID(t)){e.next=4;break}return e.abrupt("return",n.next(404));case 4:return e.next=6,n.database.findByID(t);case 6:if(!1!==(r=e.sent)){e.next=9;break}return e.abrupt("return",n.next(204));case 9:return n.response=b({},n.entity.name,r),e.abrupt("return",n.next(200));case 13:return e.prev=13,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",n.next(500));case 17:case"end":return e.stop()}}),e,null,[[0,13]])})))),b(this,"insert",h(regeneratorRuntime.mark((function e(){var t,r,a,u,i,s,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,t=n.request.body,r=!1===Array.isArray(t)?[t]:t,a=[],u=O(r),e.prev=5,u.s();case 7:if((i=u.n()).done){e.next=20;break}if(s=i.value,!1!==Y(s,n.entity)){e.next=14;break}a.push(400),e.next=18;break;case 14:return e.next=16,n.database.insert(s);case 16:o=e.sent,a.push(!1===o?500:o);case 18:e.next=7;break;case 20:e.next=25;break;case 22:e.prev=22,e.t0=e.catch(5),u.e(e.t0);case 25:return e.prev=25,u.f(),e.finish(25);case 28:if(!a.includes(400)){e.next=30;break}return e.abrupt("return",n.next(400));case 30:if(!a.includes(400)){e.next=32;break}return e.abrupt("return",n.next(500));case 32:return n.response=b({},n.entity.name,1===r.length?a[0]:a),e.abrupt("return",n.next(200));case 36:return e.prev=36,e.t1=e.catch(0),logger(e.t1),e.abrupt("return",n.next(500));case 40:case"end":return e.stop()}}),e,null,[[0,36],[5,22,25,28]])})))),b(this,"delete",h(regeneratorRuntime.mark((function e(){var t,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=W(n.request.url),!1!==n.database.validateID(t)){e.next=4;break}return e.abrupt("return",n.next(400));case 4:return e.next=6,n.database.deleteByID(t);case 6:if(!((null==(r=e.sent)?void 0:r.deletedCount)>0)){e.next=9;break}return e.abrupt("return",n.next(200));case 9:return n.response={message:"0 records deleted"},e.abrupt("return",n.next(200));case 13:return e.prev=13,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",n.next(500));case 17:case"end":return e.stop()}}),e,null,[[0,13]])})))),b(this,"update",h(regeneratorRuntime.mark((function e(){var t,r,a,u,i,s,o,c,f;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=W(n.request.url),r=n.request.body,!1!==n.database.validateID(t)){e.next=5;break}return e.abrupt("return",n.next(400));case 5:for(a=Object.keys(n.entity.fields),u={},i=0,s=a;i<s.length;i++)o=s[i],r[o]&&(u[o]=r[o]);if(!(Object.keys(u).length<1)){e.next=10;break}return e.abrupt("return",n.next(400));case 10:return e.next=12,n.database.updateByID(t,u);case 12:if(!((null==(c=e.sent)?void 0:c.modifiedCount)<1)){e.next=16;break}return n.response={message:"No records updated"},e.abrupt("return",n.next(500));case 16:return e.next=18,n.database.findByID(t);case 18:return!1!==(f=e.sent)&&(n.response=b({},n.entity.name,f)),e.abrupt("return",n.next(200));case 23:return e.prev=23,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",n.next(500));case 27:case"end":return e.stop()}}),e,null,[[0,23]])})))),b(this,"oldest",h(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n.database.getOldest();case 3:return t=e.sent,n.response=b({},n.entity.name,t),e.abrupt("return",n.next(200));case 8:return e.prev=8,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",n.next(500));case 12:case"end":return e.stop()}}),e,null,[[0,8]])})))),b(this,"latest",h(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n.database.getLatest();case 3:return t=e.sent,n.response=b({},n.entity.name,t),e.abrupt("return",n.next(200));case 8:return e.prev=8,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",n.next(500));case 12:case"end":return e.stop()}}),e,null,[[0,8]])})))),this.request=t,this.response=null,this.entity={},this.database=$.get(r)}var t;return g(e,[{key:"run",value:(t=h(regeneratorRuntime.mark((function e(){var t,r,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.request,r=t.method,e.next=3,this.validateURL();case 3:if(n=e.sent,!1!==Object.values(CONSTANTS.SERVER.METHODS).includes(r)){e.next=7;break}return e.abrupt("return",this.next(404));case 7:if(200===n){e.next=9;break}return e.abrupt("return",this.next(n));case 9:return e.next=11,this.action();case 11:return e.abrupt("return",e.sent);case 12:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),e}(),Z=function(){function e(){d(this,e)}return g(e,null,[{key:"handle",value:function(e,t){return new X(e,t).run()}}]),e}(),ee={200:{code:200,message:"OK"},204:{code:204,message:"No Content"},400:{code:400,message:"Bad Request"},401:{code:401,message:"Unauthorized"},403:{code:403,message:"Requested Resource Is Forbidden"},404:{code:404,message:"Not Found"},405:{code:405,message:"Method Not Allowed"},422:{code:422,message:"Unprocessable Entity"},429:{code:429,message:"Too Many Requests"},500:{code:500,message:"Server Error"}},te=function(){function e(){d(this,e)}return g(e,null,[{key:"get",value:function(e){return f({status:200===e},ee[e])}}]),e}();function re(e){return JSON.stringify(e)}function ne(e){var t;return!0===Array.isArray(e)?(t=e[0],e):(t=e,[e]),[t=Object.keys(t).join(","),e.map((function(e){return Object.values(e).join(",")})).join("\n")].join("\n")}function ae(e){var t=[CONSTANTS.SERVER.METHODS.INSERT,CONSTANTS.SERVER.METHODS.UPDATE];return new Promise((function(r,n){var a="";if(!1===t.includes(e.method))return r({});e.on("data",(function(e){a+=e})),e.on("end",(function(){return r(JSON.parse(a))})),e.on("error",(function(e){return n(e)}))}))}var ue,ie,se=function(){function e(t){var r=this,n=t.format,a=t.port,u=t.type,i=t.database;return d(this,e),b(this,"handler",function(){var e=h(regeneratorRuntime.mark((function e(t,n){var a,u,i,s,o,c;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,ae(t);case 3:t.body=e.sent,e.next=9;break;case 6:return e.prev=6,e.t0=e.catch(0),e.abrupt("return",r.parse(422));case 9:if(r.res=n,r.req=t,r.res.json=function(e){return r.res.payload=f(f({},te.get(200)),e),!0},r.req.server={database:r.database,format:r.format,type:r.type,port:r.port},logger(t.method+" "+t.url),!(t.url.split(".").length>1)){e.next=17;break}return e.abrupt("return",r.handleNotFound());case 17:a=[new J(_.REQUEST.BEFORE.PROCESS),new I],u=0,i=a;case 19:if(!(u<i.length)){e.next=30;break}return s=i[u],e.next=23,s.run(r.req,r.res);case 23:if(o=e.sent,!(!1!==o||200!==r.res.statusCode||"object"===p(r.res.payload))){e.next=27;break}return e.abrupt("return",r.parse(r.res.statusCode,f(f({},te.get(r.res.statusCode)),r.res.payload)));case 27:u++,e.next=19;break;case 30:return e.next=32,Z.handle(r.req,r.database);case 32:if(200!==(c=e.sent).code){e.next=35;break}return e.abrupt("return",r.parse(c.code,c.response));case 35:if(404===c.code){e.next=37;break}return e.abrupt("return",r.parse(c.code,te.get(c.code)));case 37:return e.abrupt("return",r.handleNotFound());case 38:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(t,r){return e.apply(this,arguments)}}()),this.database=i,this.format=n,this.type=u,this.port=a,this.handler}return g(e,[{key:"parse",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};switch(this.code=e,this.response=f(f({},te.get(e)),t),this.format){case CONSTANTS.SERVER.FORMATS.CSV:this.res.setHeader("Content-Type","text/csv"),this.res.setHeader("Content-Disposition","attachment;filename=response.csv"),this.response=ne(t);break;case CONSTANTS.SERVER.FORMATS.JSON:default:this.res.setHeader("Content-Type","application/json"),this.response=re(this.response)}return this.send()}},{key:"handleNotFound",value:function(){return this.parse(404,te.get(404))}},{key:"send",value:function(){this.res.writeHead(this.code),this.res.end(this.response)}}]),e}(),oe=g((function e(t){var r=this;d(this,e);var n=t.port;return t.type,t.format,this.port=n,this.host=L.address(),this.app=i.createServer(new se(t)),this.app.listen(this.port,this.host,(function(){logger("Server running on http://".concat(r.host,":").concat(r.port))})),this})),ce=function(){function e(t){t.entity;var r=t.server;d(this,e),ue=CONSTANTS.SERVER.SETTINGS.DATABASE.AUTH,ie=CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT,this.server=r,this.database=$.get((null==r?void 0:r.database)||ie),this.database.setEntity(ue)}var t,r;return g(e,[{key:"validate",value:(r=h(regeneratorRuntime.mark((function e(t){var r,n,a,u,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.database.setEntity(ue);case 3:return e.next=5,this.database.find({token:t});case 5:if((n=e.sent).entity){e.next=8;break}return e.abrupt("return",[!1,!1]);case 8:return a=$.get((null===(r=this.server)||void 0===r?void 0:r.database)||ie),e.next=11,a.setEntity(n.entity.type);case 11:return e.next=13,a.findByID(n.entity.id);case 13:return u=e.sent,e.next=16,this.database.setEntity(ue);case 16:return i=P().entities.find((function(e){return e.name===n.entity.type})),e.abrupt("return",[V(u,i),n.entity.type]);case 20:return e.prev=20,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",!1);case 24:case"end":return e.stop()}}),e,this,[[0,20]])}))),function(e){return r.apply(this,arguments)})},{key:"register",value:(t=h(regeneratorRuntime.mark((function e(t,r,n){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.database.setEntity(ue);case 3:return e.next=5,this.database.insert({token:n,entity:{type:r,id:t}});case 5:return e.abrupt("return",!0);case 9:return e.prev=9,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",!1);case 13:case"end":return e.stop()}}),e,this,[[0,9]])}))),function(e,r,n){return t.apply(this,arguments)})},{key:"generate",value:function(){return o.randomBytes(64).toString("hex")}}]),e}(),fe={TYPES:{OATH:"oauth",JWT:"jwt"},ROUTES:{LOGIN:["POST","/system/auth"]},PERMISSIONS:{INSERT:"insert",UPDATE:"update",DELETE:"delete",LIST:"list",GET:"get"},PERMISSIONS_BY_METHODS:{POST:["insert"],PATCH:["update"],DELETE:["delete"],LIST:["list"],GET:["get"]}};Object.values(fe.ROUTES).map((function(e){return e.PATH}));var pe=T(fe.ROUTES.LOGIN,2),le=pe[0],he=pe[1];(new I).use(le,he,function(){var e=h(regeneratorRuntime.mark((function e(t,r){var n,a,u,i,o,c,f,l,h,d,v,g,m,y,S;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=$.get(t.server.database),a=CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT,e.prev=2,f=null,l=null,h=O(P().entities),e.prev=6,v=regeneratorRuntime.mark((function e(){var r,a,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("object"!==p((r=d.value).auth)){e.next=9;break}return e.next=4,n.setEntity(r.name);case 4:return a=Object.keys(t.body).reduce((function(e,n){var a,u;return null!=r&&null!==(a=r.auth)&&void 0!==a&&null!==(u=a.fields)&&void 0!==u&&u.includes(n)&&(e[n]=t.body[n]),e}),{}),e.next=7,n.find(a);case 7:(u=e.sent)&&Object.keys(u).length>0&&(f=u,l=r);case 9:case"end":return e.stop()}}),e)})),h.s();case 9:if((d=h.n()).done){e.next=13;break}return e.delegateYield(v(),"t0",11);case 11:e.next=9;break;case 13:e.next=18;break;case 15:e.prev=15,e.t1=e.catch(6),h.e(e.t1);case 18:return e.prev=18,h.f(),e.finish(18);case 21:if(f&&l){e.next=23;break}return e.abrupt("return",r.statusCode=401);case 23:return null!==(u=l)&&void 0!==u&&null!==(i=u.auth)&&void 0!==i&&i.secret&&(a=l.auth.secret),g=new ce(t),m=M(f),y=g.generate(),S="jwt"!==(null===(o=l)||void 0===o||null===(c=o.auth)||void 0===c?void 0:c.type)?y:s.sign({access:y,id:m},a),e.next=30,g.register(m,l.name,S);case 30:return r.setHeader("x-auth-token",S),e.abrupt("return",r.json(b({},l.name,V(f,l))));case 34:e.prev=34,e.t2=e.catch(2),logger(e.t2),r.statusCode=500;case 38:return e.abrupt("return",!1);case 39:case"end":return e.stop()}}),e,null,[[2,34],[6,15,18,21]])})));return function(t,r){return e.apply(this,arguments)}}()),new J(_.REQUEST.BEFORE.PROCESS).set(function(){var e=h(regeneratorRuntime.mark((function e(t,r){var n,a,u,i,s,o,c,f,p,l,h,d,v,g,b;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=P(),a=n.entities,u=t.url.split("/"),i=t.url.split("?"),s=T(i,2),o=s[0],c=void 0===o?"":o,f=s[1],p=void 0===f?"":f,r.send=function(e){return t.paload=e,!0},r.error=function(e){return t.statusCode=e,!0},t.url={value:t.url,base:c,splitted:u.filter((function(e){return e.length>0})),params:p.split("&").reduce((function(e,t){var r=T(t.split("="),2),n=r[0],a=r[1];return e[n]=a,e}),{})},t.entity=a.find((function(e){return e.name===t.url.splitted[0]}))||!1,void 0!==(l=t.headers["x-auth-token"])){e.next=10;break}return e.abrupt("return",!0);case 10:if(!I.inWhitelist(t)){e.next=12;break}return e.abrupt("return",!0);case 12:return h=new ce(t),e.next=15,h.validate(l);case 15:d=e.sent,v=T(d,2),g=v[0],b=v[1],t.auth=g,t.entity=a.find((function(e){return e.name===b}))||!1;case 21:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}());var de=function(e,t){return function(r){var n=r.url.splitted.filter((function(e){return e.length>0}));return r.method===CONSTANTS.SERVER.METHODS[e]&&t(n.length)}},ve={delete:de("DELETE",(function(e){return 2===e})),update:de("UPDATE",(function(e){return 2===e})),insert:de("INSERT",(function(e){return 1===e})),list:de("LIST",(function(e){return 1===e})),get:de("GET",(function(e){return 2===e})),oldest:function(e){return e.url.value.search("oldest")>-1&&e.method===CONSTANTS.SERVER.METHODS.GET},latest:function(e){return e.url.value.search("latest")>-1&&e.method===CONSTANTS.SERVER.METHODS.GET}};new J(_.REQUEST.BEFORE.PROCESS).set(function(){var e=h(regeneratorRuntime.mark((function e(t,r){var n,a,u,i,s,o,c,f,l,h,d,v,g,b,m,y,S,E,R,x,T,k,w;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(u=CONSTANTS.SERVER.AUTH,i=u.PERMISSIONS,s=u.PERMISSIONS_BY_METHODS,o={oldest:i.LIST,latest:i.LIST,update:i.UPDATE,delete:i.DELETE,insert:i.INSERT,list:i.LIST,get:i.GET},!1!==P().entities.filter((function(e){return"object"===p(e.auth)})).length>0){e.next=5;break}return e.abrupt("return",!1);case 5:if(c=null===(n=Object.keys((null==t||null===(a=t.entity)||void 0===a?void 0:a.permission)||{}))||void 0===n?void 0:n.filter((function(e){var r;return!0===(null===(r=t.entity)||void 0===r?void 0:r.permission[e])})),f=!(null==c||!c.find((function(e){return s[t.method].includes(e)}))),!f){e.next=9;break}return e.abrupt("return",!1);case 9:l=0,h=Object.keys(ve);case 10:if(!(l<h.length)){e.next=24;break}if(d=h[l],!ve[d](t)){e.next=21;break}if(!(b=null===(v=t.entity)||void 0===v||null===(g=v.auth)||void 0===g?void 0:g.permission)){e.next=21;break}if(m=o[d]||i.LIST,y=b[t.entity.name]||b["*"],S=!!t.auth,!!!y[m]||!S){e.next=21;break}return e.abrupt("return",!1);case 21:l++,e.next=10;break;case 24:E=O(I.getRequests()),e.prev=25,E.s();case 27:if((R=E.n()).done){e.next=36;break}if(x=R.value,T=x.path,k=x.method,w=x.options,T!==t.url.base||k!==t.method){e.next=34;break}if(!0!==w.public){e.next=32;break}return e.abrupt("return",!1);case 32:if(!1!==w.public||!t.auth){e.next=34;break}return e.abrupt("return",!1);case 34:e.next=27;break;case 36:e.next=41;break;case 38:e.prev=38,e.t0=e.catch(25),E.e(e.t0);case 41:return e.prev=41,E.f(),e.finish(41);case 44:return r.statusCode=401,e.abrupt("return",!0);case 46:case"end":return e.stop()}}),e,null,[[25,38,41,44]])})));return function(t,r){return e.apply(this,arguments)}}());var ge={SEARCH:["GET","/system/search"],SYSTEM:["GET","/system"],HOME:["GET","/"]},be=T(ge.SEARCH,2),me=be[0],ye=be[1];(new I).use(me,ye,{public:!1},function(){var e=h(regeneratorRuntime.mark((function e(t,r){var n,a,u,i,s,o,c,f;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==Object.keys(t.url.params).length){e.next=2;break}return e.abrupt("return",r.error(422));case 2:return n=t.url.params,a=n.query,u=n.search,i=n.s,s=n.q,o=a||u||i||s,c=$.get(t.server.database),e.next=7,c.setEntity(t.entity.name);case 7:return e.next=9,c.search(o);case 9:return f=e.sent,e.abrupt("return",r.json({records:f}));case 11:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}());for(var Se=new I,Ee=function(){var e=h(regeneratorRuntime.mark((function e(t,r){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r.json({message:"API Running"}));case 1:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),Re=0,xe=[ge.HOME,ge.SYSTEM];Re<xe.length;Re++){var Te=T(xe[Re],2),ke=Te[0],we=Te[1];Se.use(ke,we,Ee)}var Oe=function(){function e(t){var r=t.config;d(this,e),this.servers=[];var n,a=O(B(r));try{for(a.s();!(n=a.n()).done;){var u=n.value;if(u.type===CONSTANTS.SERVER.TYPES.REST){var i=new oe(this.getConfigData(u));this.servers.push(i)}}}catch(e){a.e(e)}finally{a.f()}return this.servers}return g(e,[{key:"getConfigData",value:function(e){var t=T(B(P().database),1)[0],r=f({},e);return r.database||(r.database=t.key||CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT),r}}]),e}();global.CONSTANTS={SERVER:{METHODS:{INSERT:"POST",UPDATE:"PATCH",DELETE:"DELETE",LIST:"GET",GET:"GET",POST:"POST",PATCH:"PATCH"},EVENTS:_,AUTH:fe,SECRET:"DEFAUL-SECRET-JSON-SERVER",TYPES:{REST:"rest",SOCKET:"socket"},FORMATS:{JSON:"json",CSV:"csv"},SETTINGS:{DATABASE:{DEFAULT:"custom-db",AUTH:"json-server-auth"},REQUEST:{LIMIT:10},LANGUAGE:{DEFAULT:"pt"}}}};var Ae=function(){function e(t){d(this,e),this.json=t,this.name=t.name,this.routes=new I,global["json-server"]=t,global.logger=t.logger||console.log}var t;return g(e,[{key:"setup",value:function(e){var t=e.request,r=e.database,n=e.language;t.limit&&(CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT=t.limit),null!=r&&r.default&&(CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT=r.default),n&&(CONSTANTS.SETTINGS.LANGUAGE.DEFAULT=n)}},{key:"run",value:(t=h(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{this.databases=new $(this.json),this.servers=new Oe(this.json)}catch(e){logger(e)}case 1:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"getServerByPort",value:function(e){return this.servers.find((function(t){return t.port===e}))}}]),e}();export{Ae as default};
