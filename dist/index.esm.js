import t from"path";import e from"fs";import{ObjectId as r,MongoClient as n}from"mongodb";import a from"buffer";import u from"os";import o from"http";import i from"jsonwebtoken";import s from"crypto";function c(t,e,r,n,a,u,o){try{var i=t[u](o),s=i.value}catch(t){return void r(t)}i.done?e(s):Promise.resolve(s).then(n,a)}function f(t){return function(){var e=this,r=arguments;return new Promise((function(n,a){var u=t.apply(e,r);function o(t){c(u,n,a,o,i,"next",t)}function i(t){c(u,n,a,o,i,"throw",t)}o(void 0)}))}}function l(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function p(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function h(t,e,r){return e&&p(t.prototype,e),r&&p(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function v(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var d={exports:{}},y={exports:{}};!function(t){var e=function(t){var e,r=Object.prototype,n=r.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},u=a.iterator||"@@iterator",o=a.asyncIterator||"@@asyncIterator",i=a.toStringTag||"@@toStringTag";function s(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{s({},"")}catch(t){s=function(t,e,r){return t[e]=r}}function c(t,e,r,n){var a=e&&e.prototype instanceof y?e:y,u=Object.create(a.prototype),o=new j(n||[]);return u._invoke=function(t,e,r){var n=l;return function(a,u){if(n===h)throw new Error("Generator is already running");if(n===v){if("throw"===a)throw u;return N()}for(r.method=a,r.arg=u;;){var o=r.delegate;if(o){var i=T(o,r);if(i){if(i===d)continue;return i}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===l)throw n=v,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=h;var s=f(t,e,r);if("normal"===s.type){if(n=r.done?v:p,s.arg===d)continue;return{value:s.arg,done:r.done}}"throw"===s.type&&(n=v,r.method="throw",r.arg=s.arg)}}}(t,r,o),u}function f(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}t.wrap=c;var l="suspendedStart",p="suspendedYield",h="executing",v="completed",d={};function y(){}function b(){}function g(){}var m={};s(m,u,(function(){return this}));var S=Object.getPrototypeOf,w=S&&S(S(R([])));w&&w!==r&&n.call(w,u)&&(m=w);var E=g.prototype=y.prototype=Object.create(m);function x(t){["next","throw","return"].forEach((function(e){s(t,e,(function(t){return this._invoke(e,t)}))}))}function O(t,e){function r(a,u,o,i){var s=f(t[a],t,u);if("throw"!==s.type){var c=s.arg,l=c.value;return l&&"object"==typeof l&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,o,i)}),(function(t){r("throw",t,o,i)})):e.resolve(l).then((function(t){c.value=t,o(c)}),(function(t){return r("throw",t,o,i)}))}i(s.arg)}var a;this._invoke=function(t,n){function u(){return new e((function(e,a){r(t,n,e,a)}))}return a=a?a.then(u,u):u()}}function T(t,r){var n=t.iterator[r.method];if(n===e){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=e,T(t,r),"throw"===r.method))return d;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return d}var a=f(n,t.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,d;var u=a.arg;return u?u.done?(r[t.resultName]=u.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,d):u:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,d)}function k(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function A(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function j(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(k,this),this.reset(!0)}function R(t){if(t){var r=t[u];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var a=-1,o=function r(){for(;++a<t.length;)if(n.call(t,a))return r.value=t[a],r.done=!1,r;return r.value=e,r.done=!0,r};return o.next=o}}return{next:N}}function N(){return{value:e,done:!0}}return b.prototype=g,s(E,"constructor",g),s(g,"constructor",b),b.displayName=s(g,i,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===b||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,g):(t.__proto__=g,s(t,i,"GeneratorFunction")),t.prototype=Object.create(E),t},t.awrap=function(t){return{__await:t}},x(O.prototype),s(O.prototype,o,(function(){return this})),t.AsyncIterator=O,t.async=function(e,r,n,a,u){void 0===u&&(u=Promise);var o=new O(c(e,r,n,a),u);return t.isGeneratorFunction(r)?o:o.next().then((function(t){return t.done?t.value:o.next()}))},x(E),s(E,i,"Generator"),s(E,u,(function(){return this})),s(E,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var e=[];for(var r in t)e.push(r);return e.reverse(),function r(){for(;e.length;){var n=e.pop();if(n in t)return r.value=n,r.done=!1,r}return r.done=!0,r}},t.values=R,j.prototype={constructor:j,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(A),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function a(n,a){return i.type="throw",i.arg=t,r.next=n,a&&(r.method="next",r.arg=e),!!a}for(var u=this.tryEntries.length-1;u>=0;--u){var o=this.tryEntries[u],i=o.completion;if("root"===o.tryLoc)return a("end");if(o.tryLoc<=this.prev){var s=n.call(o,"catchLoc"),c=n.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return a(o.catchLoc,!0);if(this.prev<o.finallyLoc)return a(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return a(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return a(o.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc<=this.prev&&n.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var u=a;break}}u&&("break"===t||"continue"===t)&&u.tryLoc<=e&&e<=u.finallyLoc&&(u=null);var o=u?u.completion:{};return o.type=t,o.arg=e,u?(this.method="next",this.next=u.finallyLoc,d):this.complete(o)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),d},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),A(r),d}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var a=n.arg;A(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:R(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),d}},t}(t.exports);try{regeneratorRuntime=e}catch(t){"object"==typeof globalThis?globalThis.regeneratorRuntime=e:Function("r","regeneratorRuntime = r")(e)}}(y);var b=v(d.exports=y.exports);function g(t){return g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},g(t)}function m(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function S(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var n,a,u=[],o=!0,i=!1;try{for(r=r.call(t);!(o=(n=r.next()).done)&&(u.push(n.value),!e||u.length!==e);o=!0);}catch(t){i=!0,a=t}finally{try{o||null==r.return||r.return()}finally{if(i)throw a}}return u}}(t,e)||function(t,e){if(t){if("string"==typeof t)return m(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?m(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function E(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return x(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return x(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,a=function(){};return{s:a,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var u,o=!0,i=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return o=t.done,t},e:function(t){i=!0,u=t},f:function(){try{o||null==r.return||r.return()}finally{if(i)throw u}}}}function x(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var O={},T={public:!0},k=function(){function t(){var e=this;l(this,t),w(this,"run",function(){var t=f(b.mark((function t(e,r){var n,a,u,o,i,s,c;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:t.prev=0,n=O[e.method],a=[],u=0===e.url.base?"/":e.url.base,t.t0=b.keys(n);case 5:if((t.t1=t.t0()).done){t.next=30;break}if(o=t.t1.value,u!==o){t.next=28;break}i=E(n[o]),t.prev=9,i.s();case 11:if((s=i.n()).done){t.next=20;break}return c=s.value.callback,t.t2=a,t.next=16,Promise.resolve(c(e,r)).catch(logger);case 16:t.t3=t.sent,t.t2.push.call(t.t2,t.t3);case 18:t.next=11;break;case 20:t.next=25;break;case 22:t.prev=22,t.t4=t.catch(9),i.e(t.t4);case 25:return t.prev=25,i.f(),t.finish(25);case 28:t.next=5;break;case 30:return t.abrupt("return",a.length>0&&!1===a.includes(!1));case 33:return t.prev=33,t.t5=t.catch(0),logger(t.t5),t.abrupt("return",!1);case 37:case"end":return t.stop()}}),t,null,[[0,33],[9,22,25,28]])})));return function(e,r){return t.apply(this,arguments)}}()),w(this,"getArgs",(function(t){var e=S(t,2);return{method:e[0],path:e[1],options:"object"===g(t[2])?t[2]:T,callback:"function"==typeof t[3]?t[3]:t[2]}})),w(this,"register",(function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];var a=e.getArgs(r),u=a.method,o=a.path,i=a.options,s=a.callback;void 0===O[u]&&(O[u]={}),!1===Array.isArray(O[u][o])&&(O[u][o]=[]),O[u][o].push({options:i,callback:s})})),w(this,"use",(function(){return e.register.apply(e,arguments)})),w(this,"get",(function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];return e.register.apply(e,[CONSTANTS.SERVER.METHODS.GET].concat(r))})),w(this,"post",(function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];return e.register.apply(e,[CONSTANTS.SERVER.METHODS.POST].concat(r))})),w(this,"patch",(function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];return e.register.apply(e,[CONSTANTS.SERVER.METHODS.PATCH].concat(r))})),w(this,"delete",(function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];return e.register.apply(e,[CONSTANTS.SERVER.METHODS.DELETE].concat(r))}))}return h(t,null,[{key:"getRequests",value:function(){var t=[];for(var e in O)for(var r in O[e])t.push({options:O[e][r][0].options,method:e,path:r});return t}},{key:"inWhitelist",value:function(e){return!!t.getRequests().find((function(t){return t.path===e.url.base&&t.method===e.method&&!1!==t.options.public}))}}]),t}();function A(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function j(t,e){return j=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},j(t,e)}function R(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&j(t,e)}function N(t,e){if(e&&("object"===g(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return A(t)}function I(t){return I=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},I(t)}function P(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return D(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return D(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,a=function(){};return{s:a,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var u,o=!0,i=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return o=t.done,t},e:function(t){i=!0,u=t},f:function(){try{o||null==r.return||r.return()}finally{if(i)throw u}}}}function D(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var L=function(){function r(n){var a=this;l(this,r),w(this,"writeFile",(function(t){return e.writeFileSync(a.filePath,JSON.stringify(t,null,2))})),w(this,"readFile",(function(){return e.existsSync(a.filePath)?JSON.parse(e.readFileSync(a.filePath,"utf8")):(e.writeFileSync(a.filePath,"{}"),{})})),w(this,"getAll",(function(){return a.db=a.readFile(),a.db[a.name][a.entity]})),w(this,"setAll",(function(t){a.db=t,a.writeFile(t)})),w(this,"add",(function(t){!1===Array.isArray(a.db[a.name][a.entity])&&(a.db[a.name][a.entity]=[]),a.db[a.name][a.entity].push(t),a.writeFile(a.db)})),w(this,"set",(function(t){a.db[a.name][a.entity]=t,a.writeFile(a.db)})),w(this,"find",(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=a.getAll(),r=Object.keys(t),n=[];if(0===r.length)return e;var u,o=P(e);try{var i=function(){var e=u.value,a=[];r.forEach((function(r){e[r]===t[r]&&a.push(!0)})),a.length===r.length&&n.push(e)};for(o.s();!(u=o.n()).done;)i()}catch(t){o.e(t)}finally{o.f()}return n})),w(this,"indexOf",(function(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=Object.keys(e),n=0,u=P(a.getAll());try{var o=function(){var a=t.value,u=[];if(r.forEach((function(t){a[t]===e[t]&&u.push(!0)})),u.length===r.length)return{v:n};n++};for(u.s();!(t=u.n()).done;){var i=o();if("object"===g(i))return i.v}}catch(t){u.e(t)}finally{u.f()}return-1})),this.filePath=t.join(process.cwd(),"db.json"),this.name=n,this.db=this.readFile()}return h(r,[{key:"setEntity",value:function(t){this.entity=t}}]),r}();function C(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return M(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return M(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,a=function(){};return{s:a,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var u,o=!0,i=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return o=t.done,t},e:function(t){i=!0,u=t},f:function(){try{o||null==r.return||r.return()}finally{if(i)throw u}}}}function M(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function U(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function B(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?U(Object(r),!0).forEach((function(e){w(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):U(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}var G=h((function t(){var e=this;l(this,t),w(this,"list",f(b.mark((function t(){var r,n,a,u,o=arguments;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=o.length>0&&void 0!==o[0]?o[0]:{},n=o.length>1&&void 0!==o[1]?o[1]:0,t.prev=2,a=e.storage.find(r),u=CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT+n,t.abrupt("return",a.slice(n,u));case 8:return t.prev=8,t.t0=t.catch(2),logger(t.t0),t.abrupt("return",!1);case 12:case"end":return t.stop()}}),t,null,[[2,8]])})))),w(this,"find",function(){var t=f(b.mark((function t(r){var n,a,u;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.storage.find(r);case 3:return n=t.sent,a=S(n,1),u=a[0],t.abrupt("return",u||!1);case 9:return t.prev=9,t.t0=t.catch(0),t.abrupt("return",!1);case 12:case"end":return t.stop()}}),t,null,[[0,9]])})));return function(e){return t.apply(this,arguments)}}()),w(this,"findByID",function(){var t=f(b.mark((function t(r){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.find({id:r});case 3:if(t.t0=t.sent,t.t0){t.next=6;break}t.t0=!1;case 6:return t.abrupt("return",t.t0);case 9:return t.prev=9,t.t1=t.catch(0),t.abrupt("return",!1);case 12:case"end":return t.stop()}}),t,null,[[0,9]])})));return function(e){return t.apply(this,arguments)}}()),w(this,"insert",function(){var t=f(b.mark((function t(n){var a,u;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,a=new Date,u=B({updated:a,created:a,id:r()},n),e.storage.add(u),t.abrupt("return",u);case 7:return t.prev=7,t.t0=t.catch(0),logger(t.t0),t.abrupt("return",!1);case 11:case"end":return t.stop()}}),t,null,[[0,7]])})));return function(e){return t.apply(this,arguments)}}()),w(this,"insertMany",function(){var t=f(b.mark((function t(n){var a,u,o,i,s,c;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:t.prev=0,a=new Date,u=[],o=C(n);try{for(o.s();!(i=o.n()).done;)s=i.value,c=B({updated:a,created:a,id:r()},s),e.storage.add(c),u.push(c)}catch(t){o.e(t)}finally{o.f()}return t.abrupt("return",u);case 8:return t.prev=8,t.t0=t.catch(0),t.abrupt("return",!1);case 11:case"end":return t.stop()}}),t,null,[[0,8]])})));return function(e){return t.apply(this,arguments)}}()),w(this,"update",function(){var t=f(b.mark((function t(r,n){var a,u;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,!((a=e.storage.indexOf(r))<0)){t.next=4;break}return t.abrupt("return",!1);case 4:return(u=e.storage.getAll())[a]=B(B({},u[a]),n),e.storage.set(u),t.abrupt("return",{modifiedCount:1});case 10:return t.prev=10,t.t0=t.catch(0),logger(t.t0),t.abrupt("return",!1);case 14:case"end":return t.stop()}}),t,null,[[0,10]])})));return function(e,r){return t.apply(this,arguments)}}()),w(this,"updateByID",function(){var t=f(b.mark((function t(r,n){var a;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.update({id:r},n);case 3:return a=t.sent,t.abrupt("return",a);case 7:return t.prev=7,t.t0=t.catch(0),logger(t.t0),t.abrupt("return",!1);case 11:case"end":return t.stop()}}),t,null,[[0,7]])})));return function(e,r){return t.apply(this,arguments)}}()),w(this,"updateMany",function(){var t=f(b.mark((function t(e,r){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",!1);case 1:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}()),w(this,"delete",function(){var t=f(b.mark((function t(r){var n;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.storage.find(r).map((function(t){return JSON.stringify(t)})),e.storage.set(e.storage.getAll().filter((function(t){return!n.includes(JSON.stringify(t))}))),t.abrupt("return",{deletedCount:n.length});case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),w(this,"deleteByID",function(){var t=f(b.mark((function t(r){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.delete({id:r});case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),w(this,"deleteMany",function(){var t=f(b.mark((function t(e){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",!1);case 1:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),w(this,"getLatest",function(){var t=f(b.mark((function t(r){var n,a,u,o=arguments;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=o.length>1&&void 0!==o[1]?o[1]:0,a=e.storage.find(r),u=CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT+n,t.abrupt("return",a.slice(n,u));case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),w(this,"getOldest",function(){var t=f(b.mark((function t(r){var n,a,u,o=arguments;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=o.length>1&&void 0!==o[1]?o[1]:0,a=e.storage.find(r).reverse(),u=CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT+n,t.abrupt("return",a.slice(n,u));case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}));function F(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function V(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=I(t);if(e){var a=I(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return N(this,r)}}var $=function(t){R(r,G);var e=V(r);function r(t){var n,a=t.name,u=t.key;return l(this,r),w(A(n=e.call(this)),"connect",f(b.mark((function t(){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",A(n));case 1:case"end":return t.stop()}}),t)})))),w(A(n),"setEntity",function(){var t=f(b.mark((function t(e){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n.entity=e,t.next=3,n.storage.setEntity(e);case 3:void 0===n.storage.db[n.name][n.entity]&&n.storage.set([]);case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),w(A(n),"count",f(b.mark((function t(){var e;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",(null===(e=n.storage.db[n.name][n.entity])||void 0===e?void 0:e.length)||0);case 2:case"end":return t.stop()}}),t)})))),w(A(n),"validateID",function(){var t=f(b.mark((function t(e){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("string"==typeof e){t.next=2;break}return t.abrupt("return",!1);case 2:return t.abrupt("return",e.match(/^[0-9a-fA-F]{24}$/));case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),n.storage=new L(a),n.storage.db[a]||(n.storage.db[a]={}),n.name=a,n.key=u,n.storage.setAll(function(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?F(Object(r),!0).forEach((function(e){w(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):F(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}({},n.storage.db)),n}return h(r)}(),H={};function _(){return global["json-server"]||{}}function q(t){return void 0===t?[]:Array.isArray(t)?t:["string","number","boolean"].includes(g(t))||"object"===g(t)&&Object.keys(t).length>0?[t]:[]}function Q(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t.id||t._id}function Y(t){return J.apply(this,arguments)}function J(){return J=f(b.mark((function t(e){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,Promise.resolve(e());case 3:return t.abrupt("return",t.sent);case 6:t.prev=6,t.t0=t.catch(0);case 8:case"end":return t.stop()}}),t,null,[[0,6]])}))),J.apply(this,arguments)}function W(t,e){var r=e.fields;if(!t||!r)return t;var n=Object.keys(r).filter((function(t){var e;return!0===(null===(e=r[t])||void 0===e?void 0:e.secure)}));return Object.keys(t).reduce((function(e,r){return!1===n.includes(r)&&(e[r]=t[r]),e}),{})}function K(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return z(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return z(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,a=function(){};return{s:a,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var u,o=!0,i=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return o=t.done,t},e:function(t){i=!0,u=t},f:function(){try{o||null==r.return||r.return()}finally{if(i)throw u}}}}function z(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function X(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function Z(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?X(Object(r),!0).forEach((function(e){w(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):X(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}!function(t){var e=t,r=a.Buffer,n=u;e.toBuffer=function(t,e,n){var a;if(n=~~n,this.isV4Format(t))a=e||new r(n+4),t.split(/\./g).map((function(t){a[n++]=255&parseInt(t,10)}));else if(this.isV6Format(t)){var u,o=t.split(":",8);for(u=0;u<o.length;u++){var i;this.isV4Format(o[u])&&(i=this.toBuffer(o[u]),o[u]=i.slice(0,2).toString("hex")),i&&++u<8&&o.splice(u,0,i.slice(2,4).toString("hex"))}if(""===o[0])for(;o.length<8;)o.unshift("0");else if(""===o[o.length-1])for(;o.length<8;)o.push("0");else if(o.length<8){for(u=0;u<o.length&&""!==o[u];u++);var s=[u,1];for(u=9-o.length;u>0;u--)s.push("0");o.splice.apply(o,s)}for(a=e||new r(n+16),u=0;u<o.length;u++){var c=parseInt(o[u],16);a[n++]=c>>8&255,a[n++]=255&c}}if(!a)throw Error("Invalid ip address: "+t);return a},e.toString=function(t,e,r){e=~~e;var n=[];if(4===(r=r||t.length-e)){for(var a=0;a<r;a++)n.push(t[e+a]);n=n.join(".")}else if(16===r){for(a=0;a<r;a+=2)n.push(t.readUInt16BE(e+a).toString(16));n=(n=(n=n.join(":")).replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3")).replace(/:{3,4}/,"::")}return n};var o=/^(\d{1,3}\.){3,3}\d{1,3}$/,i=/^(::)?(((\d{1,3}\.){3}(\d{1,3}){1})?([0-9a-f]){0,4}:{0,2}){1,8}(::)?$/i;function s(t){return t?t.toLowerCase():"ipv4"}e.isV4Format=function(t){return o.test(t)},e.isV6Format=function(t){return i.test(t)},e.fromPrefixLen=function(t,n){var a=4;"ipv6"===(n=t>32?"ipv6":s(n))&&(a=16);for(var u=new r(a),o=0,i=u.length;o<i;++o){var c=8;t<8&&(c=t),t-=c,u[o]=255&~(255>>c)}return e.toString(u)},e.mask=function(t,n){t=e.toBuffer(t),n=e.toBuffer(n);var a=new r(Math.max(t.length,n.length)),u=0;if(t.length===n.length)for(u=0;u<t.length;u++)a[u]=t[u]&n[u];else if(4===n.length)for(u=0;u<n.length;u++)a[u]=t[t.length-4+u]&n[u];else{for(u=0;u<a.length-6;u++)a[u]=0;for(a[10]=255,a[11]=255,u=0;u<t.length;u++)a[u+12]=t[u]&n[u+12];u+=12}for(;u<a.length;u++)a[u]=0;return e.toString(a)},e.cidr=function(t){var r=t.split("/"),n=r[0];if(2!==r.length)throw new Error("invalid CIDR subnet: "+n);var a=e.fromPrefixLen(parseInt(r[1],10));return e.mask(n,a)},e.subnet=function(t,r){for(var n=e.toLong(e.mask(t,r)),a=e.toBuffer(r),u=0,o=0;o<a.length;o++)if(255===a[o])u+=8;else for(var i=255&a[o];i;)i=i<<1&255,u++;var s=Math.pow(2,32-u);return{networkAddress:e.fromLong(n),firstAddress:s<=2?e.fromLong(n):e.fromLong(n+1),lastAddress:s<=2?e.fromLong(n+s-1):e.fromLong(n+s-2),broadcastAddress:e.fromLong(n+s-1),subnetMask:r,subnetMaskLength:u,numHosts:s<=2?s:s-2,length:s,contains:function(t){return n===e.toLong(e.mask(t,r))}}},e.cidrSubnet=function(t){var r=t.split("/"),n=r[0];if(2!==r.length)throw new Error("invalid CIDR subnet: "+n);var a=e.fromPrefixLen(parseInt(r[1],10));return e.subnet(n,a)},e.not=function(t){for(var r=e.toBuffer(t),n=0;n<r.length;n++)r[n]=255^r[n];return e.toString(r)},e.or=function(t,r){if(t=e.toBuffer(t),r=e.toBuffer(r),t.length===r.length){for(var n=0;n<t.length;++n)t[n]|=r[n];return e.toString(t)}var a=t,u=r;r.length>t.length&&(a=r,u=t);var o=a.length-u.length;for(n=o;n<a.length;++n)a[n]|=u[n-o];return e.toString(a)},e.isEqual=function(t,r){if(t=e.toBuffer(t),r=e.toBuffer(r),t.length===r.length){for(var n=0;n<t.length;n++)if(t[n]!==r[n])return!1;return!0}if(4===r.length){var a=r;r=t,t=a}for(n=0;n<10;n++)if(0!==r[n])return!1;var u=r.readUInt16BE(10);if(0!==u&&65535!==u)return!1;for(n=0;n<4;n++)if(t[n]!==r[n+12])return!1;return!0},e.isPrivate=function(t){return/^(::f{4}:)?10\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(t)||/^(::f{4}:)?192\.168\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(t)||/^(::f{4}:)?172\.(1[6-9]|2\d|30|31)\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(t)||/^(::f{4}:)?127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(t)||/^(::f{4}:)?169\.254\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(t)||/^f[cd][0-9a-f]{2}:/i.test(t)||/^fe80:/i.test(t)||/^::1$/.test(t)||/^::$/.test(t)},e.isPublic=function(t){return!e.isPrivate(t)},e.isLoopback=function(t){return/^(::f{4}:)?127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})/.test(t)||/^fe80::1$/.test(t)||/^::1$/.test(t)||/^::$/.test(t)},e.loopback=function(t){if("ipv4"!==(t=s(t))&&"ipv6"!==t)throw new Error("family must be ipv4 or ipv6");return"ipv4"===t?"127.0.0.1":"fe80::1"},e.address=function(t,r){var a,u=n.networkInterfaces();if(r=s(r),t&&"private"!==t&&"public"!==t){var o=u[t].filter((function(t){return t.family.toLowerCase()===r}));if(0===o.length)return;return o[0].address}return(a=Object.keys(u).map((function(n){var a=u[n].filter((function(n){return n.family=n.family.toLowerCase(),n.family===r&&!e.isLoopback(n.address)&&(!t||("public"===t?e.isPrivate(n.address):e.isPublic(n.address)))}));return a.length?a[0].address:void 0})).filter(Boolean)).length?a[0]:e.loopback(r)},e.toLong=function(t){var e=0;return t.split(".").forEach((function(t){e<<=8,e+=parseInt(t)})),e>>>0},e.fromLong=function(t){return(t>>>24)+"."+(t>>16&255)+"."+(t>>8&255)+"."+(255&t)}}(H);var tt=function(){function t(){l(this,t),this.entity=null,this.collection={}}var e,n,a,u,o,i,s,c,p,v,d,y,g,m;return h(t,[{key:"list",value:(m=f(b.mark((function t(){var e,r,n=arguments;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=n.length>0&&void 0!==n[0]?n[0]:{},r=n.length>1&&void 0!==n[1]?n[1]:0,t.prev=2,t.next=5,this.collection.find(e).limit(CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT).skip(r).sort({updated:-1}).toArray();case 5:return t.abrupt("return",t.sent);case 8:return t.prev=8,t.t0=t.catch(2),t.abrupt("return",!1);case 11:case"end":return t.stop()}}),t,this,[[2,8]])}))),function(){return m.apply(this,arguments)})},{key:"find",value:(g=f(b.mark((function t(e){var r;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.collection.findOne(e);case 2:return r=t.sent,t.abrupt("return",r);case 4:case"end":return t.stop()}}),t,this)}))),function(t){return g.apply(this,arguments)})},{key:"findByID",value:(y=f(b.mark((function t(e){var n;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this.find({_id:r(e)});case 3:return n=t.sent,t.abrupt("return",n);case 7:return t.prev=7,t.t0=t.catch(0),t.abrupt("return",!1);case 10:case"end":return t.stop()}}),t,this,[[0,7]])}))),function(t){return y.apply(this,arguments)})},{key:"insert",value:(d=f(b.mark((function t(e){var r;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,r=new Date,t.next=4,this.collection.insertOne(Z({updated:r,created:r},e));case 4:return t.next=7,this.find(e);case 7:return t.abrupt("return",t.sent);case 10:return t.prev=10,t.t0=t.catch(0),logger(t.t0),t.abrupt("return",!1);case 14:case"end":return t.stop()}}),t,this,[[0,10]])}))),function(t){return d.apply(this,arguments)})},{key:"insertMany",value:(v=f(b.mark((function t(e){var r,n,a;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,r=new Date,n=e.map((function(t){return Z(Z({},t),{},{updated:r,created:r})})),t.next=5,this.collection.insertMany(n);case 5:return a=t.sent,t.abrupt("return",a.ops);case 9:return t.prev=9,t.t0=t.catch(0),t.abrupt("return",!1);case 12:case"end":return t.stop()}}),t,this,[[0,9]])}))),function(t){return v.apply(this,arguments)})},{key:"updateByID",value:(p=f(b.mark((function t(e,n){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.update({_id:r(e)},n);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t,this)}))),function(t,e){return p.apply(this,arguments)})},{key:"update",value:(c=f(b.mark((function t(e,r){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.collection.updateOne(e,{$set:Z({updated:new Date},r)});case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t,this)}))),function(t,e){return c.apply(this,arguments)})},{key:"updateMany",value:(s=f(b.mark((function t(e,r){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.collection.updateMany(e,{$set:Z({updated:new Date},r)});case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t,this)}))),function(t,e){return s.apply(this,arguments)})},{key:"delete",value:(i=f(b.mark((function t(e){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.collection.deleteOne(e);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t,this)}))),function(t){return i.apply(this,arguments)})},{key:"deleteByID",value:(o=f(b.mark((function t(e){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.delete({_id:r(e)});case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t,this)}))),function(t){return o.apply(this,arguments)})},{key:"deleteMany",value:(u=f(b.mark((function t(e){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.collection.deleteMany(e);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t,this)}))),function(t){return u.apply(this,arguments)})},{key:"getLatest",value:(a=f(b.mark((function t(e){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.collection.find(e).limit(CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT).sort({$natural:-1}).toArray();case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t,this)}))),function(t){return a.apply(this,arguments)})},{key:"getOldest",value:(n=f(b.mark((function t(e){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.collection.find(e).limit(CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT).sort({$natural:1}).toArray();case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})},{key:"search",value:(e=f(b.mark((function t(e){var r,n,a,u,o,i,s,c=this,f=arguments;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=!(f.length>1&&void 0!==f[1])||f[1],n=_(),a=n.entities,u=[],o=K(a),t.prev=4,s=b.mark((function t(){var r,n,a,o,s,f,l;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=i.value,n=r.name,a=r.fields,o=c.db.collection(n),s=Object.keys(a).filter((function(t){var e,r;return[a[t],null===(e=a[t])||void 0===e?void 0:e.type].includes("string")&&!0!==(null===(r=a[t])||void 0===r?void 0:r.secure)})),f={$text:{$diacriticSensitive:!1,$caseSensitive:!1,$search:e}},"string"!=typeof e&&(f=s.reduce((function(t,r){return t[r]=e,t}),{})),t.next=7,o.find(f).toArray();case 7:(l=t.sent).length>0&&u.push(l.map((function(t){return{type:n,record:t}})));case 9:case"end":return t.stop()}}),t)})),o.s();case 7:if((i=o.n()).done){t.next=11;break}return t.delegateYield(s(),"t0",9);case 9:t.next=7;break;case 11:t.next=16;break;case 13:t.prev=13,t.t1=t.catch(4),o.e(t.t1);case 16:return t.prev=16,o.f(),t.finish(16);case 19:if(0!==u.length||!r){t.next=21;break}return t.abrupt("return",this.search(new RegExp(e,"gi"),!1));case 21:return t.abrupt("return",u.flat());case 22:case"end":return t.stop()}}),t,this,[[4,13,16,19]])}))),function(t){return e.apply(this,arguments)})}]),t}();function et(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return rt(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return rt(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,a=function(){};return{s:a,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var u,o=!0,i=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return o=t.done,t},e:function(t){i=!0,u=t},f:function(){try{o||null==r.return||r.return()}finally{if(i)throw u}}}}function rt(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function nt(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=I(t);if(e){var a=I(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return N(this,r)}}var at=function(t){R(s,tt);var e,r,a,u,o,i=nt(s);function s(t){var e,r=t.uri,a=t.name,u=t.key;return l(this,s),(e=i.call(this)).client=new n(r),e.name=a,e.uri=r,e.key=u,e}return h(s,[{key:"createTextIndexes",value:(o=f(b.mark((function t(){var e,r,n,a;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e=et(_().entities),t.prev=1,e.s();case 3:if((r=e.n()).done){t.next=15;break}return n=r.value,t.prev=5,a=this.db.collection(n.name),t.next=9,a.createIndex({"$**":"text"},{default_language:CONSTANTS.SERVER.SETTINGS.LANGUAGE.DEFAULT});case 9:t.next=13;break;case 11:t.prev=11,t.t0=t.catch(5);case 13:t.next=3;break;case 15:t.next=20;break;case 17:t.prev=17,t.t1=t.catch(1),e.e(t.t1);case 20:return t.prev=20,e.f(),t.finish(20);case 23:case"end":return t.stop()}}),t,this,[[1,17,20,23],[5,11]])}))),function(){return o.apply(this,arguments)})},{key:"connect",value:(u=f(b.mark((function t(){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this.client.connect();case 3:return this.db=this.client.db(this.name),t.next=6,this.createTextIndexes();case 6:return t.abrupt("return",this);case 9:return t.prev=9,t.t0=t.catch(0),console.log(t.t0),t.abrupt("return",t.t0);case 13:case"end":return t.stop()}}),t,this,[[0,9]])}))),function(){return u.apply(this,arguments)})},{key:"setEntity",value:(a=f(b.mark((function t(e){var r=this;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Y(f(b.mark((function t(){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,r.db.createCollection(e);case 2:case"end":return t.stop()}}),t)}))));case 2:this.entity=e,this.collection=this.db.collection(e);case 4:case"end":return t.stop()}}),t,this)}))),function(t){return a.apply(this,arguments)})},{key:"count",value:(r=f(b.mark((function t(){var e,r=arguments;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=r.length>0&&void 0!==r[0]?r[0]:{},t.abrupt("return",this.collection.count(e));case 2:case"end":return t.stop()}}),t,this)}))),function(){return r.apply(this,arguments)})},{key:"validateID",value:(e=f(b.mark((function t(e){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.match(/^[0-9a-fA-F]{24}$/));case 1:case"end":return t.stop()}}),t)}))),function(t){return e.apply(this,arguments)})}]),s}();function ut(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return ot(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return ot(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,a=function(){};return{s:a,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var u,o=!0,i=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return o=t.done,t},e:function(t){i=!0,u=t},f:function(){try{o||null==r.return||r.return()}finally{if(i)throw u}}}}function ot(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var it={},st=function(){function t(e){l(this,t),this.list=q(e.database),this.databases=it,0===this.list.length&&this.list.push({name:CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT,key:CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT,type:"custom"}),this.setup()}var e;return h(t,[{key:"setup",value:(e=f(b.mark((function t(){var e,r,n,a,u;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e=ut(this.list),t.prev=1,e.s();case 3:if((r=e.n()).done){t.next=19;break}return n=r.value,t.prev=5,a=this.getClassByType(n.type),u=new a(n),t.next=10,u.connect();case 10:this.databases[n.key]=u,t.next=17;break;case 13:t.prev=13,t.t0=t.catch(5),logger(t.t0),this.databases[n.key]=t.t0;case 17:t.next=3;break;case 19:t.next=24;break;case 21:t.prev=21,t.t1=t.catch(1),e.e(t.t1);case 24:return t.prev=24,e.f(),t.finish(24);case 27:0===Object.keys(this.databases).length&&logger("No databases connected");case 28:case"end":return t.stop()}}),t,this,[[1,21,24,27],[5,13]])}))),function(){return e.apply(this,arguments)})},{key:"getClassByType",value:function(t){switch(t){case"mongo-db":case"mongodb":case"mongoDB":case"mongo":return at;default:return $}}},{key:"getDB",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT;return this.databases[t]}}],[{key:"get",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT;return it[t]}},{key:"closeAll",value:function(t){var e=[];for(var r in it){var n,a;"function"==typeof(null===(n=it[r])||void 0===n||null===(a=n.client)||void 0===a?void 0:a.close)&&(it[r].client.close(),e.push(r))}return e}}]),t}(),ct={REQUEST:{BEFORE:{RESPONSE:"REQUEST.BEFORE.RESPONSE",PROCESS:"REQUEST.BEFORE.PROCESS"}}};function ft(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return lt(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return lt(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,a=function(){};return{s:a,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var u,o=!0,i=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return o=t.done,t},e:function(t){i=!0,u=t},f:function(){try{o||null==r.return||r.return()}finally{if(i)throw u}}}}function lt(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var pt={},ht=function(){function t(e){var r=this;return l(this,t),w(this,"run",f(b.mark((function t(){var e,n,a,u,o=arguments;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=pt[r.event],!1!==Array.isArray(e)){t.next=3;break}return t.abrupt("return",!1);case 3:n=ft(e),t.prev=4,n.s();case 6:if((a=n.n()).done){t.next=22;break}return u=a.value,t.prev=8,t.next=11,Promise.resolve(u.apply(void 0,o));case 11:if(!1!==t.sent){t.next=14;break}return t.abrupt("return",!1);case 14:t.next=20;break;case 16:return t.prev=16,t.t0=t.catch(8),logger(t.t0),t.abrupt("return",!1);case 20:t.next=6;break;case 22:t.next=27;break;case 24:t.prev=24,t.t1=t.catch(4),n.e(t.t1);case 27:return t.prev=27,n.f(),t.finish(27);case 30:return t.abrupt("return",!0);case 31:case"end":return t.stop()}}),t,null,[[4,24,27,30],[8,16]])})))),this.event=e,!1===Array.isArray(pt[e])&&(pt[e]=[]),this}return h(t,[{key:"set",value:function(e){return t.setListener(this.event,e)}},{key:"remove",value:function(e){return t.removeListener(this.event,e)}}],[{key:"setListener",value:function(t,e){return pt[t].push(e)-1}},{key:"removeListener",value:function(t,e){try{pt[t].filter((function(t,r){return e!==r}));return!0}catch(t){return!1}}}]),t}();function vt(t,e){var r=e.fields,n=Object.keys(r).map((function(t){var e,n;return{type:(null===(e=r[t])||void 0===e?void 0:e.type)||g(r[t]),required:!(null===(n=r[t])||void 0===n||!n.required),key:t}})).filter((function(t){return t.required})).reduce((function(t,e){return e.required&&(t[e.key]=e.type),t}),{});for(var a in n)if(g(t[a])!==n[a])return!1;return!0}function dt(t){return t.splitted[1]}var yt=function(t,e){return function(r){var n=r.url.splitted.filter((function(t){return t.length>0}));return r.method===CONSTANTS.SERVER.METHODS[t]&&e(n.length)}},bt={delete:yt("DELETE",(function(t){return 2===t})),update:yt("UPDATE",(function(t){return 2===t})),insert:yt("INSERT",(function(t){return 1===t})),list:yt("LIST",(function(t){return 1===t})),get:yt("GET",(function(t){return 2===t})),oldest:function(t){var e,r;return(null==t||null===(e=t.url)||void 0===e||null===(r=e.value)||void 0===r?void 0:r.search("oldest"))>-1&&(null==t?void 0:t.method)===CONSTANTS.SERVER.METHODS.GET},latest:function(t){var e,r;return(null==t||null===(e=t.url)||void 0===e||null===(r=e.value)||void 0===r?void 0:r.search("latest"))>-1&&(null==t?void 0:t.method)===CONSTANTS.SERVER.METHODS.GET}};function gt(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return mt(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return mt(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,a=function(){};return{s:a,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var u,o=!0,i=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return o=t.done,t},e:function(t){i=!0,u=t},f:function(){try{o||null==r.return||r.return()}finally{if(i)throw u}}}}function mt(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var St=function(){function t(e,r){var n=this;l(this,t),w(this,"next",(function(t){return{response:n.response,code:t}})),w(this,"validateURL",f(b.mark((function t(){var e,r,a,u,o,i;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:t.prev=0,e=_(),r=S(n.request.url.splitted,1),a=r[0],u=gt(e.entities),t.prev=4,u.s();case 6:if((o=u.n()).done){t.next=16;break}if(i=o.value,!(a===i.name)){t.next=14;break}return n.entity=i,t.next=13,n.database.setEntity(i.name);case 13:return t.abrupt("return",200);case 14:t.next=6;break;case 16:t.next=21;break;case 18:t.prev=18,t.t0=t.catch(4),u.e(t.t0);case 21:return t.prev=21,u.f(),t.finish(21);case 24:return t.abrupt("return",404);case 27:return t.prev=27,t.t1=t.catch(0),logger(t.t1),t.abrupt("return",500);case 31:case"end":return t.stop()}}),t,null,[[0,27],[4,18,21,24]])})))),w(this,"action",f(b.mark((function t(){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!bt.oldest(n.request)){t.next=4;break}return t.next=3,n.oldest();case 3:case 7:case 11:case 15:case 19:case 23:case 27:return t.abrupt("return",t.sent);case 4:if(!bt.latest(n.request)){t.next=8;break}return t.next=7,n.latest();case 8:if(!bt.update(n.request)){t.next=12;break}return t.next=11,n.update();case 12:if(!bt.delete(n.request)){t.next=16;break}return t.next=15,n.delete();case 16:if(!bt.insert(n.request)){t.next=20;break}return t.next=19,n.insert();case 20:if(!bt.list(n.request)){t.next=24;break}return t.next=23,n.list();case 24:if(!bt.get(n.request)){t.next=28;break}return t.next=27,n.get();case 28:return t.abrupt("return",n.next(404));case 29:case"end":return t.stop()}}),t)})))),w(this,"list",f(b.mark((function t(){var e,r,a,u;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,Promise.all([n.database.list(),n.database.count()]);case 3:return e=t.sent,r=S(e,2),a=r[0],u=r[1],n.response={records:a,count:u},t.abrupt("return",n.next(200));case 11:return t.prev=11,t.t0=t.catch(0),logger(t.t0),t.abrupt("return",n.next(500));case 15:case"end":return t.stop()}}),t,null,[[0,11]])})))),w(this,"get",f(b.mark((function t(){var e,r;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,e=n.request.url.splitted[1]+"",!1!==n.database.validateID(e)){t.next=4;break}return t.abrupt("return",n.next(404));case 4:return t.next=6,n.database.findByID(e);case 6:if(!1!==(r=t.sent)){t.next=9;break}return t.abrupt("return",n.next(204));case 9:return n.response=w({},n.entity.name,r),t.abrupt("return",n.next(200));case 13:return t.prev=13,t.t0=t.catch(0),logger(t.t0),t.abrupt("return",n.next(500));case 17:case"end":return t.stop()}}),t,null,[[0,13]])})))),w(this,"insert",f(b.mark((function t(){var e,r,a,u,o,i,s;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:t.prev=0,e=n.request.body,r=!1===Array.isArray(e)?[e]:e,a=[],u=gt(r),t.prev=5,u.s();case 7:if((o=u.n()).done){t.next=20;break}if(i=o.value,!1!==vt(i,n.entity)){t.next=14;break}a.push(400),t.next=18;break;case 14:return t.next=16,n.database.insert(i);case 16:s=t.sent,a.push(!1===s?500:s);case 18:t.next=7;break;case 20:t.next=25;break;case 22:t.prev=22,t.t0=t.catch(5),u.e(t.t0);case 25:return t.prev=25,u.f(),t.finish(25);case 28:if(!a.includes(400)){t.next=30;break}return t.abrupt("return",n.next(400));case 30:if(!a.includes(400)){t.next=32;break}return t.abrupt("return",n.next(500));case 32:return n.response=w({},n.entity.name,1===r.length?a[0]:a),t.abrupt("return",n.next(200));case 36:return t.prev=36,t.t1=t.catch(0),logger(t.t1),t.abrupt("return",n.next(500));case 40:case"end":return t.stop()}}),t,null,[[0,36],[5,22,25,28]])})))),w(this,"delete",f(b.mark((function t(){var e,r;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,e=dt(n.request.url),!1!==n.database.validateID(e)){t.next=4;break}return t.abrupt("return",n.next(400));case 4:return t.next=6,n.database.deleteByID(e);case 6:if(!((null==(r=t.sent)?void 0:r.deletedCount)>0)){t.next=9;break}return t.abrupt("return",n.next(200));case 9:return n.response={message:"0 records deleted"},t.abrupt("return",n.next(200));case 13:return t.prev=13,t.t0=t.catch(0),logger(t.t0),t.abrupt("return",n.next(500));case 17:case"end":return t.stop()}}),t,null,[[0,13]])})))),w(this,"update",f(b.mark((function t(){var e,r,a,u,o,i,s,c,f;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,e=dt(n.request.url),r=n.request.body,!1!==n.database.validateID(e)){t.next=5;break}return t.abrupt("return",n.next(400));case 5:for(a=Object.keys(n.entity.fields),u={},o=0,i=a;o<i.length;o++)s=i[o],r[s]&&(u[s]=r[s]);if(!(Object.keys(u).length<1)){t.next=10;break}return t.abrupt("return",n.next(400));case 10:return t.next=12,n.database.updateByID(e,u);case 12:if(!((null==(c=t.sent)?void 0:c.modifiedCount)<1)){t.next=16;break}return n.response={message:"No records updated"},t.abrupt("return",n.next(500));case 16:return t.next=18,n.database.findByID(e);case 18:return!1!==(f=t.sent)&&(n.response=w({},n.entity.name,f)),t.abrupt("return",n.next(200));case 23:return t.prev=23,t.t0=t.catch(0),logger(t.t0),t.abrupt("return",n.next(500));case 27:case"end":return t.stop()}}),t,null,[[0,23]])})))),w(this,"oldest",f(b.mark((function t(){var e;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,n.database.getOldest();case 3:return e=t.sent,n.response=w({},n.entity.name,e),t.abrupt("return",n.next(200));case 8:return t.prev=8,t.t0=t.catch(0),logger(t.t0),t.abrupt("return",n.next(500));case 12:case"end":return t.stop()}}),t,null,[[0,8]])})))),w(this,"latest",f(b.mark((function t(){var e;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,n.database.getLatest();case 3:return e=t.sent,n.response=w({},n.entity.name,e),t.abrupt("return",n.next(200));case 8:return t.prev=8,t.t0=t.catch(0),logger(t.t0),t.abrupt("return",n.next(500));case 12:case"end":return t.stop()}}),t,null,[[0,8]])})))),this.request=e,this.response=null,this.entity={},this.database=st.get(r)}var e;return h(t,[{key:"run",value:(e=f(b.mark((function t(){var e,r,n;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=this.request,r=e.method,t.next=3,this.validateURL();case 3:if(n=t.sent,!1!==Object.values(CONSTANTS.SERVER.METHODS).includes(r)){t.next=7;break}return t.abrupt("return",this.next(404));case 7:if(200===n){t.next=9;break}return t.abrupt("return",this.next(n));case 9:return t.next=11,this.action();case 11:return t.abrupt("return",t.sent);case 12:case"end":return t.stop()}}),t,this)}))),function(){return e.apply(this,arguments)})}]),t}(),wt=function(){function t(){l(this,t)}return h(t,null,[{key:"handle",value:function(t,e){return new St(t,e).run()}}]),t}(),Et={200:{code:200,message:"OK"},204:{code:204,message:"No Content"},400:{code:400,message:"Bad Request"},401:{code:401,message:"Unauthorized"},403:{code:403,message:"Requested Resource Is Forbidden"},404:{code:404,message:"Not Found"},405:{code:405,message:"Method Not Allowed"},422:{code:422,message:"Unprocessable Entity"},429:{code:429,message:"Too Many Requests"},500:{code:500,message:"Server Error"}};function xt(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}var Ot=function(){function t(){l(this,t)}return h(t,null,[{key:"get",value:function(t){return function(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?xt(Object(r),!0).forEach((function(e){w(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):xt(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}({status:200===t},Et[t])}}]),t}();function Tt(t){return JSON.stringify(t)}function kt(t){var e;return!0===Array.isArray(t)?(e=t[0],t):(e=t,[t]),[e=Object.keys(e).join(","),t.map((function(t){return Object.values(t).join(",")})).join("\n")].join("\n")}function At(t){var e=[CONSTANTS.SERVER.METHODS.INSERT,CONSTANTS.SERVER.METHODS.UPDATE];return new Promise((function(r,n){var a="";if(!1===e.includes(t.method))return r({});t.on("data",(function(t){a+=t})),t.on("end",(function(){return r(JSON.parse(a))})),t.on("error",(function(t){return n(t)}))}))}function jt(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function Rt(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?jt(Object(r),!0).forEach((function(e){w(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):jt(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}var Nt,It,Pt=function(){function t(e){var r=this,n=e.format,a=e.port,u=e.type,o=e.database;return l(this,t),w(this,"handler",function(){var t=f(b.mark((function t(e,n){var a,u,o,i,s,c;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,At(e);case 3:e.body=t.sent,t.next=9;break;case 6:return t.prev=6,t.t0=t.catch(0),t.abrupt("return",r.parse(422));case 9:if(r.res=n,r.req=e,r.res.json=function(t){return r.res.payload=Rt(Rt({},Ot.get(200)),t),!0},r.req.server={database:r.database,format:r.format,type:r.type,port:r.port},logger(e.method+" "+e.url),!(e.url.split(".").length>1)){t.next=17;break}return t.abrupt("return",r.handleNotFound());case 17:a=[new ht(ct.REQUEST.BEFORE.PROCESS),new k],u=0,o=a;case 19:if(!(u<o.length)){t.next=30;break}return i=o[u],t.next=23,i.run(r.req,r.res);case 23:if(s=t.sent,!(!1!==s||200!==r.res.statusCode||"object"===g(r.res.payload))){t.next=27;break}return t.abrupt("return",r.parse(r.res.statusCode,Rt(Rt({},Ot.get(r.res.statusCode)),r.res.payload)));case 27:u++,t.next=19;break;case 30:return t.next=32,wt.handle(r.req,r.database);case 32:if(200!==(c=t.sent).code){t.next=35;break}return t.abrupt("return",r.parse(c.code,c.response));case 35:if(404===c.code){t.next=37;break}return t.abrupt("return",r.parse(c.code,Ot.get(c.code)));case 37:return t.abrupt("return",r.handleNotFound());case 38:case"end":return t.stop()}}),t,null,[[0,6]])})));return function(e,r){return t.apply(this,arguments)}}()),this.database=o,this.format=n,this.type=u,this.port=a,this.handler}return h(t,[{key:"parse",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};switch(this.code=t,this.response=Rt(Rt({},Ot.get(t)),e),this.format){case CONSTANTS.SERVER.FORMATS.CSV:this.res.setHeader("Content-Type","text/csv"),this.res.setHeader("Content-Disposition","attachment;filename=response.csv"),this.response=kt(e);break;case CONSTANTS.SERVER.FORMATS.JSON:default:this.res.setHeader("Content-Type","application/json"),this.response=Tt(this.response)}return this.send()}},{key:"handleNotFound",value:function(){return this.parse(404,Ot.get(404))}},{key:"send",value:function(){this.res.writeHead(this.code),this.res.end(this.response)}}]),t}(),Dt=h((function t(e){var r=this;l(this,t);var n=e.port;return e.type,e.format,this.port=n,this.host=H.address(),this.app=o.createServer(new Pt(e)),this.app.listen(this.port,this.host,(function(){logger("Server running on http://".concat(r.host,":").concat(r.port))})),this})),Lt=function(){function t(e){e.entity;var r=e.server;l(this,t),Nt=CONSTANTS.SERVER.SETTINGS.DATABASE.AUTH,It=CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT,this.server=r,this.database=st.get((null==r?void 0:r.database)||It),this.database.setEntity(Nt)}var e,r;return h(t,[{key:"validate",value:(r=f(b.mark((function t(e){var r,n,a,u,o;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this.database.setEntity(Nt);case 3:return t.next=5,this.database.find({token:e});case 5:if((n=t.sent).entity){t.next=8;break}return t.abrupt("return",[!1,!1]);case 8:return a=st.get((null===(r=this.server)||void 0===r?void 0:r.database)||It),t.next=11,a.setEntity(n.entity.type);case 11:return t.next=13,a.findByID(n.entity.id);case 13:return u=t.sent,t.next=16,this.database.setEntity(Nt);case 16:return o=_().entities.find((function(t){return t.name===n.entity.type})),t.abrupt("return",[W(u,o),n.entity.type]);case 20:return t.prev=20,t.t0=t.catch(0),logger(t.t0),t.abrupt("return",!1);case 24:case"end":return t.stop()}}),t,this,[[0,20]])}))),function(t){return r.apply(this,arguments)})},{key:"register",value:(e=f(b.mark((function t(e,r,n){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this.database.setEntity(Nt);case 3:return t.next=5,this.database.insert({token:n,entity:{type:r,id:e}});case 5:return t.abrupt("return",!0);case 9:return t.prev=9,t.t0=t.catch(0),logger(t.t0),t.abrupt("return",!1);case 13:case"end":return t.stop()}}),t,this,[[0,9]])}))),function(t,r,n){return e.apply(this,arguments)})},{key:"generate",value:function(){return s.randomBytes(64).toString("hex")}}]),t}(),Ct={TYPES:{OATH:"oauth",JWT:"jwt"},ROUTES:{LOGIN:["POST","/system/auth"]},PERMISSIONS:{INSERT:"insert",UPDATE:"update",DELETE:"delete",LIST:"list",GET:"get"},PERMISSIONS_BY_METHODS:{POST:["insert"],PATCH:["update"],DELETE:["delete"],LIST:["list"],GET:["get"]}};function Mt(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return Ut(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Ut(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,a=function(){};return{s:a,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var u,o=!0,i=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return o=t.done,t},e:function(t){i=!0,u=t},f:function(){try{o||null==r.return||r.return()}finally{if(i)throw u}}}}function Ut(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}Object.values(Ct.ROUTES).map((function(t){return t.PATH}));var Bt=S(Ct.ROUTES.LOGIN,2),Gt=Bt[0],Ft=Bt[1];(new k).use(Gt,Ft,function(){var t=f(b.mark((function t(e,r){var n,a,u,o,s,c,f,l,p,h,v,d,y,m,S;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=st.get(e.server.database),a=CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT,t.prev=2,f=null,l=null,p=Mt(_().entities),t.prev=6,v=b.mark((function t(){var r,a,u;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("object"!==g((r=h.value).auth)){t.next=9;break}return t.next=4,n.setEntity(r.name);case 4:return a=Object.keys(e.body).reduce((function(t,n){var a,u;return null!=r&&null!==(a=r.auth)&&void 0!==a&&null!==(u=a.fields)&&void 0!==u&&u.includes(n)&&(t[n]=e.body[n]),t}),{}),t.next=7,n.find(a);case 7:(u=t.sent)&&Object.keys(u).length>0&&(f=u,l=r);case 9:case"end":return t.stop()}}),t)})),p.s();case 9:if((h=p.n()).done){t.next=13;break}return t.delegateYield(v(),"t0",11);case 11:t.next=9;break;case 13:t.next=18;break;case 15:t.prev=15,t.t1=t.catch(6),p.e(t.t1);case 18:return t.prev=18,p.f(),t.finish(18);case 21:if(f&&l){t.next=23;break}return t.abrupt("return",r.statusCode=401);case 23:return null!==(u=l)&&void 0!==u&&null!==(o=u.auth)&&void 0!==o&&o.secret&&(a=l.auth.secret),d=new Lt(e),y=Q(f),m=d.generate(),S="jwt"!==(null===(s=l)||void 0===s||null===(c=s.auth)||void 0===c?void 0:c.type)?m:i.sign({access:m,id:y},a),t.next=30,d.register(y,l.name,S);case 30:return r.setHeader("x-auth-token",S),t.abrupt("return",r.json(w({},l.name,W(f,l))));case 34:t.prev=34,t.t2=t.catch(2),logger(t.t2),r.statusCode=500;case 38:return t.abrupt("return",!1);case 39:case"end":return t.stop()}}),t,null,[[2,34],[6,15,18,21]])})));return function(e,r){return t.apply(this,arguments)}}()),new ht(ct.REQUEST.BEFORE.PROCESS).set(function(){var t=f(b.mark((function t(e,r){var n,a,u,o,i,s,c,f,l,p,h,v,d,y,g;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=_(),a=n.entities,u=e.url.split("/"),o=e.url.split("?"),i=S(o,2),s=i[0],c=void 0===s?"":s,f=i[1],l=void 0===f?"":f,r.send=function(t){return e.paload=t,!0},r.error=function(t){return e.statusCode=t,!0},e.url={value:e.url,base:c,splitted:u.filter((function(t){return t.length>0})),params:l.split("&").reduce((function(t,e){var r=S(e.split("="),2),n=r[0],a=r[1];return t[n]=a,t}),{})},e.entity=a.find((function(t){return t.name===e.url.splitted[0]}))||!1,void 0!==(p=e.headers["x-auth-token"])){t.next=10;break}return t.abrupt("return",!0);case 10:if(!k.inWhitelist(e)){t.next=12;break}return t.abrupt("return",!0);case 12:return h=new Lt(e),t.next=15,h.validate(p);case 15:v=t.sent,d=S(v,2),y=d[0],g=d[1],e.auth=y,e.entity=a.find((function(t){return t.name===g}))||!1;case 21:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}());var Vt=function(t,e){return function(r){var n=r.url.splitted.filter((function(t){return t.length>0}));return r.method===CONSTANTS.SERVER.METHODS[t]&&e(n.length)}},$t={delete:Vt("DELETE",(function(t){return 2===t})),update:Vt("UPDATE",(function(t){return 2===t})),insert:Vt("INSERT",(function(t){return 1===t})),list:Vt("LIST",(function(t){return 1===t})),get:Vt("GET",(function(t){return 2===t})),oldest:function(t){var e,r;return(null==t||null===(e=t.url)||void 0===e||null===(r=e.value)||void 0===r?void 0:r.search("oldest"))>-1&&(null==t?void 0:t.method)===CONSTANTS.SERVER.METHODS.GET},latest:function(t){var e,r;return(null==t||null===(e=t.url)||void 0===e||null===(r=e.value)||void 0===r?void 0:r.search("latest"))>-1&&(null==t?void 0:t.method)===CONSTANTS.SERVER.METHODS.GET}};function Ht(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return _t(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return _t(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,a=function(){};return{s:a,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var u,o=!0,i=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return o=t.done,t},e:function(t){i=!0,u=t},f:function(){try{o||null==r.return||r.return()}finally{if(i)throw u}}}}function _t(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}new ht(ct.REQUEST.BEFORE.PROCESS).set(function(){var t=f(b.mark((function t(e,r){var n,a,u,o,i,s,c,f,l,p,h,v,d,y,m,S,w,E,x,O,T,A,j;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(u=CONSTANTS.SERVER.AUTH,o=u.PERMISSIONS,i=u.PERMISSIONS_BY_METHODS,s={oldest:o.LIST,latest:o.LIST,update:o.UPDATE,delete:o.DELETE,insert:o.INSERT,list:o.LIST,get:o.GET},!1!==_().entities.filter((function(t){return"object"===g(t.auth)})).length>0){t.next=5;break}return t.abrupt("return",!1);case 5:if(c=null===(n=Object.keys((null==e||null===(a=e.entity)||void 0===a?void 0:a.permission)||{}))||void 0===n?void 0:n.filter((function(t){var r;return!0===(null===(r=e.entity)||void 0===r?void 0:r.permission[t])})),f=!(null==c||!c.find((function(t){return i[e.method].includes(t)}))),!f){t.next=9;break}return t.abrupt("return",!1);case 9:l=0,p=Object.keys($t);case 10:if(!(l<p.length)){t.next=24;break}if(h=p[l],!$t[h](e)){t.next=21;break}if(!(y=null===(v=e.entity)||void 0===v||null===(d=v.auth)||void 0===d?void 0:d.permission)){t.next=21;break}if(m=s[h]||o.LIST,S=y[e.entity.name]||y["*"],w=!!e.auth,!!!S[m]||!w){t.next=21;break}return t.abrupt("return",!1);case 21:l++,t.next=10;break;case 24:E=Ht(k.getRequests()),t.prev=25,E.s();case 27:if((x=E.n()).done){t.next=36;break}if(O=x.value,T=O.path,A=O.method,j=O.options,T!==e.url.base||A!==e.method){t.next=34;break}if(!0!==j.public){t.next=32;break}return t.abrupt("return",!1);case 32:if(!1!==j.public||!e.auth){t.next=34;break}return t.abrupt("return",!1);case 34:t.next=27;break;case 36:t.next=41;break;case 38:t.prev=38,t.t0=t.catch(25),E.e(t.t0);case 41:return t.prev=41,E.f(),t.finish(41);case 44:return r.statusCode=401,t.abrupt("return",!0);case 46:case"end":return t.stop()}}),t,null,[[25,38,41,44]])})));return function(e,r){return t.apply(this,arguments)}}());var qt={SEARCH:["GET","/system/search"],SYSTEM:["GET","/system"],HOME:["GET","/"]},Qt=S(qt.SEARCH,2),Yt=Qt[0],Jt=Qt[1];(new k).use(Yt,Jt,{public:!1},function(){var t=f(b.mark((function t(e,r){var n,a,u,o,i,s,c,f;return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==Object.keys(e.url.params).length){t.next=2;break}return t.abrupt("return",r.error(422));case 2:return n=e.url.params,a=n.query,u=n.search,o=n.s,i=n.q,s=a||u||o||i,c=st.get(e.server.database),t.next=7,c.setEntity(e.entity.name);case 7:return t.next=9,c.search(s);case 9:return f=t.sent,t.abrupt("return",r.json({records:f}));case 11:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}());for(var Wt=new k,Kt=function(){var t=f(b.mark((function t(e,r){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",r.json({message:"API Running"}));case 1:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}(),zt=0,Xt=[qt.HOME,qt.SYSTEM];zt<Xt.length;zt++){var Zt=S(Xt[zt],2),te=Zt[0],ee=Zt[1];Wt.use(te,ee,Kt)}function re(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function ne(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return ae(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return ae(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,a=function(){};return{s:a,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var u,o=!0,i=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return o=t.done,t},e:function(t){i=!0,u=t},f:function(){try{o||null==r.return||r.return()}finally{if(i)throw u}}}}function ae(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var ue=function(){function t(e){var r=e.config;l(this,t),this.servers=[];var n,a=ne(q(r));try{for(a.s();!(n=a.n()).done;){var u=n.value;if(u.type===CONSTANTS.SERVER.TYPES.REST){var o=new Dt(this.getConfigData(u));this.servers.push(o)}}}catch(t){a.e(t)}finally{a.f()}return this.servers}return h(t,[{key:"getConfigData",value:function(t){var e=S(q(_().database),1)[0],r=function(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?re(Object(r),!0).forEach((function(e){w(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):re(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}({},t);return r.database||(r.database=(null==e?void 0:e.key)||CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT),r}}]),t}();global.CONSTANTS={SERVER:{METHODS:{INSERT:"POST",UPDATE:"PATCH",DELETE:"DELETE",LIST:"GET",GET:"GET",POST:"POST",PATCH:"PATCH"},EVENTS:ct,AUTH:Ct,SECRET:"DEFAUL-SECRET-JSON-SERVER",TYPES:{REST:"rest",SOCKET:"socket"},FORMATS:{JSON:"json",CSV:"csv"},SETTINGS:{DATABASE:{DEFAULT:"custom-db",AUTH:"json-server-auth"},REQUEST:{LIMIT:10},LANGUAGE:{DEFAULT:"pt"}}}};var oe=function(){function t(e){l(this,t),this.json=e,this.name=e.name,this.routes=new k,global["json-server"]=e,global.logger=e.logger||console.log}var e;return h(t,[{key:"setup",value:function(t){var e=t.request,r=t.database,n=t.language;e.limit&&(CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT=e.limit),null!=r&&r.default&&(CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT=r.default),n&&(CONSTANTS.SETTINGS.LANGUAGE.DEFAULT=n)}},{key:"run",value:(e=f(b.mark((function t(){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:try{this.databases=new st(this.json),this.servers=new ue(this.json)}catch(t){logger(t)}case 1:case"end":return t.stop()}}),t,this)}))),function(){return e.apply(this,arguments)})},{key:"getServerByPort",value:function(t){return this.servers.find((function(e){return e.port===t}))}}]),t}();export{oe as default};
