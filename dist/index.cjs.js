"use strict";var e=require("path"),t=require("fs"),r=require("mongodb"),n=require("buffer"),a=require("os"),u=require("http"),i=require("jsonwebtoken"),s=require("crypto");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=o(e),f=o(t),l=o(n),p=o(a),h=o(u),d=o(i),v=o(s);function g(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function b(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?g(Object(r),!0).forEach((function(t){T(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):g(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function y(e){return y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},y(e)}function m(e,t,r,n,a,u,i){try{var s=e[u](i),o=s.value}catch(e){return void r(e)}s.done?t(o):Promise.resolve(o).then(n,a)}function S(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var u=e.apply(t,r);function i(e){m(u,n,a,i,s,"next",e)}function s(e){m(u,n,a,i,s,"throw",e)}i(void 0)}))}}function E(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function R(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function x(e,t,r){return t&&R(e.prototype,t),r&&R(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function T(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function k(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&O(e,t)}function w(e){return w=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},w(e)}function O(e,t){return O=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},O(e,t)}function A(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function N(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return A(e)}function I(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=w(e);if(t){var a=w(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return N(this,r)}}function D(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==r)return;var n,a,u=[],i=!0,s=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(u.push(n.value),!t||u.length!==t);i=!0);}catch(e){s=!0,a=e}finally{try{i||null==r.return||r.return()}finally{if(s)throw a}}return u}(e,t)||j(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function j(e,t){if(e){if("string"==typeof e)return C(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?C(e,t):void 0}}function C(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function L(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=j(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var u,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,u=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw u}}}}var P={},B={public:!0},M=function(){function e(){var t=this;E(this,e),T(this,"run",function(){var e=S(regeneratorRuntime.mark((function e(t,r){var n,a,u,i,s,o,c;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,n=P[t.method],a=[],u=0===t.url.base?"/":t.url.base,e.t0=regeneratorRuntime.keys(n);case 5:if((e.t1=e.t0()).done){e.next=30;break}if(i=e.t1.value,u!==i){e.next=28;break}s=L(n[i]),e.prev=9,s.s();case 11:if((o=s.n()).done){e.next=20;break}return c=o.value.callback,e.t2=a,e.next=16,Promise.resolve(c(t,r)).catch(logger);case 16:e.t3=e.sent,e.t2.push.call(e.t2,e.t3);case 18:e.next=11;break;case 20:e.next=25;break;case 22:e.prev=22,e.t4=e.catch(9),s.e(e.t4);case 25:return e.prev=25,s.f(),e.finish(25);case 28:e.next=5;break;case 30:return e.abrupt("return",a.length>0&&!1===a.includes(!1));case 33:return e.prev=33,e.t5=e.catch(0),logger(e.t5),e.abrupt("return",!1);case 37:case"end":return e.stop()}}),e,null,[[0,33],[9,22,25,28]])})));return function(t,r){return e.apply(this,arguments)}}()),T(this,"getArgs",(function(e){var t=D(e,2);return{method:t[0],path:t[1],options:"object"===y(e[2])?e[2]:B,callback:"function"==typeof e[3]?e[3]:e[2]}})),T(this,"register",(function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];var a=t.getArgs(r),u=a.method,i=a.path,s=a.options,o=a.callback;void 0===P[u]&&(P[u]={}),!1===Array.isArray(P[u][i])&&(P[u][i]=[]),P[u][i].push({options:s,callback:o})})),T(this,"use",(function(){return t.register.apply(t,arguments)})),T(this,"get",(function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t.register.apply(t,[CONSTANTS.SERVER.METHODS.GET].concat(r))})),T(this,"post",(function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t.register.apply(t,[CONSTANTS.SERVER.METHODS.POST].concat(r))})),T(this,"patch",(function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t.register.apply(t,[CONSTANTS.SERVER.METHODS.PATCH].concat(r))})),T(this,"delete",(function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t.register.apply(t,[CONSTANTS.SERVER.METHODS.DELETE].concat(r))}))}return x(e,null,[{key:"getRequests",value:function(){var e=[];for(var t in P)for(var r in P[t])e.push({options:P[t][r][0].options,method:t,path:r});return e}},{key:"inWhitelist",value:function(t){return!!e.getRequests().find((function(e){return e.path===t.url.base&&e.method===t.method&&!1!==e.options.public}))}}]),e}(),U=function(){function e(t){var r=this;E(this,e),T(this,"writeFile",(function(e){return f.default.writeFileSync(r.filePath,JSON.stringify(e,null,2))})),T(this,"readFile",(function(){return f.default.existsSync(r.filePath)?JSON.parse(f.default.readFileSync(r.filePath,"utf8")):(f.default.writeFileSync(r.filePath,"{}"),{})})),T(this,"getAll",(function(){return r.db=r.readFile(),r.db[r.name][r.entity]})),T(this,"setAll",(function(e){r.db=e,r.writeFile(e)})),T(this,"add",(function(e){!1===Array.isArray(r.db[r.name][r.entity])&&(r.db[r.name][r.entity]=[]),r.db[r.name][r.entity].push(e),r.writeFile(r.db)})),T(this,"set",(function(e){r.db[r.name][r.entity]=e,r.writeFile(r.db)})),T(this,"find",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=r.getAll(),n=Object.keys(e),a=[];if(0===n.length)return t;var u,i=L(t);try{var s=function(){var t=u.value,r=[];n.forEach((function(n){t[n]===e[n]&&r.push(!0)})),r.length===n.length&&a.push(t)};for(i.s();!(u=i.n()).done;)s()}catch(e){i.e(e)}finally{i.f()}return a})),T(this,"indexOf",(function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=Object.keys(t),a=0,u=L(r.getAll());try{var i=function(){var r=e.value,u=[];if(n.forEach((function(e){r[e]===t[e]&&u.push(!0)})),u.length===n.length)return{v:a};a++};for(u.s();!(e=u.n()).done;){var s=i();if("object"===y(s))return s.v}}catch(e){u.e(e)}finally{u.f()}return-1})),this.filePath=c.default.join(process.cwd(),"db.json"),this.name=t,this.db=this.readFile()}return x(e,[{key:"setEntity",value:function(e){this.entity=e}}]),e}(),F=x((function e(){var t=this;E(this,e),T(this,"list",S(regeneratorRuntime.mark((function e(){var r,n,a,u,i=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=i.length>0&&void 0!==i[0]?i[0]:{},n=i.length>1&&void 0!==i[1]?i[1]:0,e.prev=2,a=t.storage.find(r),u=CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT+n,e.abrupt("return",a.slice(n,u));case 8:return e.prev=8,e.t0=e.catch(2),logger(e.t0),e.abrupt("return",!1);case 12:case"end":return e.stop()}}),e,null,[[2,8]])})))),T(this,"find",function(){var e=S(regeneratorRuntime.mark((function e(r){var n,a,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.storage.find(r);case 3:return n=e.sent,a=D(n,1),u=a[0],e.abrupt("return",u||!1);case 9:return e.prev=9,e.t0=e.catch(0),e.abrupt("return",!1);case 12:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(t){return e.apply(this,arguments)}}()),T(this,"findByID",function(){var e=S(regeneratorRuntime.mark((function e(r){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.find({id:r});case 3:if(e.t0=e.sent,e.t0){e.next=6;break}e.t0=!1;case 6:return e.abrupt("return",e.t0);case 9:return e.prev=9,e.t1=e.catch(0),e.abrupt("return",!1);case 12:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(t){return e.apply(this,arguments)}}()),T(this,"insert",function(){var e=S(regeneratorRuntime.mark((function e(n){var a,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=new Date,u=b({updated:a,created:a,id:r.ObjectId()},n),t.storage.add(u),e.abrupt("return",u);case 7:return e.prev=7,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",!1);case 11:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t){return e.apply(this,arguments)}}()),T(this,"insertMany",function(){var e=S(regeneratorRuntime.mark((function e(n){var a,u,i,s,o,c;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,a=new Date,u=[],i=L(n);try{for(i.s();!(s=i.n()).done;)o=s.value,c=b({updated:a,created:a,id:r.ObjectId()},o),t.storage.add(c),u.push(c)}catch(e){i.e(e)}finally{i.f()}return e.abrupt("return",u);case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",!1);case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t){return e.apply(this,arguments)}}()),T(this,"update",function(){var e=S(regeneratorRuntime.mark((function e(r,n){var a,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!((a=t.storage.indexOf(r))<0)){e.next=4;break}return e.abrupt("return",!1);case 4:return(u=t.storage.getAll())[a]=b(b({},u[a]),n),t.storage.set(u),e.abrupt("return",{modifiedCount:1});case 10:return e.prev=10,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",!1);case 14:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(t,r){return e.apply(this,arguments)}}()),T(this,"updateByID",function(){var e=S(regeneratorRuntime.mark((function e(r,n){var a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.update({id:r},n);case 3:return a=e.sent,e.abrupt("return",a);case 7:return e.prev=7,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",!1);case 11:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,r){return e.apply(this,arguments)}}()),T(this,"updateMany",function(){var e=S(regeneratorRuntime.mark((function e(t,r){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()),T(this,"delete",function(){var e=S(regeneratorRuntime.mark((function e(r){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.storage.find(r).map((function(e){return JSON.stringify(e)})),t.storage.set(t.storage.getAll().filter((function(e){return!n.includes(JSON.stringify(e))}))),e.abrupt("return",{deletedCount:n.length});case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),T(this,"deleteByID",function(){var e=S(regeneratorRuntime.mark((function e(r){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.delete({id:r});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),T(this,"deleteMany",function(){var e=S(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),T(this,"getLatest",function(){var e=S(regeneratorRuntime.mark((function e(r){var n,a,u,i=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:0,a=t.storage.find(r),u=CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT+n,e.abrupt("return",a.slice(n,u));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),T(this,"getOldest",function(){var e=S(regeneratorRuntime.mark((function e(r){var n,a,u,i=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:0,a=t.storage.find(r).reverse(),u=CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT+n,e.abrupt("return",a.slice(n,u));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())})),V=function(e){k(r,F);var t=I(r);function r(e){var n,a=e.name,u=e.key;return E(this,r),T(A(n=t.call(this)),"connect",S(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",A(n));case 1:case"end":return e.stop()}}),e)})))),T(A(n),"setEntity",function(){var e=S(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.entity=t,e.next=3,n.storage.setEntity(t);case 3:void 0===n.storage.db[n.name][n.entity]&&n.storage.set([]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),T(A(n),"count",S(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(null===(t=n.storage.db[n.name][n.entity])||void 0===t?void 0:t.length)||0);case 2:case"end":return e.stop()}}),e)})))),T(A(n),"validateID",function(){var e=S(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("string"==typeof t){e.next=2;break}return e.abrupt("return",!1);case 2:return e.abrupt("return",t.match(/^[0-9a-fA-F]{24}$/));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),n.storage=new U(a),n.storage.db[a]||(n.storage.db[a]={}),n.name=a,n.key=u,n.storage.setAll(b({},n.storage.db)),n}return x(r)}(),G={};function q(){return global["json-server"]||{}}function H(e){return void 0===e?[]:Array.isArray(e)?e:["string","number","boolean"].includes(y(e))||"object"===y(e)&&Object.keys(e).length>0?[e]:[]}function $(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e.id||e._id}function _(e){return Q.apply(this,arguments)}function Q(){return Q=S(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Promise.resolve(t());case 3:return e.abrupt("return",e.sent);case 6:e.prev=6,e.t0=e.catch(0);case 8:case"end":return e.stop()}}),e,null,[[0,6]])}))),Q.apply(this,arguments)}function J(e,t){var r=t.fields;if(!e||!r)return e;var n=Object.keys(r).filter((function(e){var t;return!0===(null===(t=r[e])||void 0===t?void 0:t.secure)}));return Object.keys(e).reduce((function(t,r){return!1===n.includes(r)&&(t[r]=e[r]),t}),{})}!function(e){var t=e,r=l.default.Buffer,n=p.default;t.toBuffer=function(e,t,n){var a;if(n=~~n,this.isV4Format(e))a=t||new r(n+4),e.split(/\./g).map((function(e){a[n++]=255&parseInt(e,10)}));else if(this.isV6Format(e)){var u,i=e.split(":",8);for(u=0;u<i.length;u++){var s;this.isV4Format(i[u])&&(s=this.toBuffer(i[u]),i[u]=s.slice(0,2).toString("hex")),s&&++u<8&&i.splice(u,0,s.slice(2,4).toString("hex"))}if(""===i[0])for(;i.length<8;)i.unshift("0");else if(""===i[i.length-1])for(;i.length<8;)i.push("0");else if(i.length<8){for(u=0;u<i.length&&""!==i[u];u++);var o=[u,1];for(u=9-i.length;u>0;u--)o.push("0");i.splice.apply(i,o)}for(a=t||new r(n+16),u=0;u<i.length;u++){var c=parseInt(i[u],16);a[n++]=c>>8&255,a[n++]=255&c}}if(!a)throw Error("Invalid ip address: "+e);return a},t.toString=function(e,t,r){t=~~t;var n=[];if(4===(r=r||e.length-t)){for(var a=0;a<r;a++)n.push(e[t+a]);n=n.join(".")}else if(16===r){for(a=0;a<r;a+=2)n.push(e.readUInt16BE(t+a).toString(16));n=(n=(n=n.join(":")).replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3")).replace(/:{3,4}/,"::")}return n};var a=/^(\d{1,3}\.){3,3}\d{1,3}$/,u=/^(::)?(((\d{1,3}\.){3}(\d{1,3}){1})?([0-9a-f]){0,4}:{0,2}){1,8}(::)?$/i;function i(e){return e?e.toLowerCase():"ipv4"}t.isV4Format=function(e){return a.test(e)},t.isV6Format=function(e){return u.test(e)},t.fromPrefixLen=function(e,n){var a=4;"ipv6"===(n=e>32?"ipv6":i(n))&&(a=16);for(var u=new r(a),s=0,o=u.length;s<o;++s){var c=8;e<8&&(c=e),e-=c,u[s]=255&~(255>>c)}return t.toString(u)},t.mask=function(e,n){e=t.toBuffer(e),n=t.toBuffer(n);var a=new r(Math.max(e.length,n.length)),u=0;if(e.length===n.length)for(u=0;u<e.length;u++)a[u]=e[u]&n[u];else if(4===n.length)for(u=0;u<n.length;u++)a[u]=e[e.length-4+u]&n[u];else{for(u=0;u<a.length-6;u++)a[u]=0;for(a[10]=255,a[11]=255,u=0;u<e.length;u++)a[u+12]=e[u]&n[u+12];u+=12}for(;u<a.length;u++)a[u]=0;return t.toString(a)},t.cidr=function(e){var r=e.split("/"),n=r[0];if(2!==r.length)throw new Error("invalid CIDR subnet: "+n);var a=t.fromPrefixLen(parseInt(r[1],10));return t.mask(n,a)},t.subnet=function(e,r){for(var n=t.toLong(t.mask(e,r)),a=t.toBuffer(r),u=0,i=0;i<a.length;i++)if(255===a[i])u+=8;else for(var s=255&a[i];s;)s=s<<1&255,u++;var o=Math.pow(2,32-u);return{networkAddress:t.fromLong(n),firstAddress:o<=2?t.fromLong(n):t.fromLong(n+1),lastAddress:o<=2?t.fromLong(n+o-1):t.fromLong(n+o-2),broadcastAddress:t.fromLong(n+o-1),subnetMask:r,subnetMaskLength:u,numHosts:o<=2?o:o-2,length:o,contains:function(e){return n===t.toLong(t.mask(e,r))}}},t.cidrSubnet=function(e){var r=e.split("/"),n=r[0];if(2!==r.length)throw new Error("invalid CIDR subnet: "+n);var a=t.fromPrefixLen(parseInt(r[1],10));return t.subnet(n,a)},t.not=function(e){for(var r=t.toBuffer(e),n=0;n<r.length;n++)r[n]=255^r[n];return t.toString(r)},t.or=function(e,r){if(e=t.toBuffer(e),r=t.toBuffer(r),e.length===r.length){for(var n=0;n<e.length;++n)e[n]|=r[n];return t.toString(e)}var a=e,u=r;r.length>e.length&&(a=r,u=e);var i=a.length-u.length;for(n=i;n<a.length;++n)a[n]|=u[n-i];return t.toString(a)},t.isEqual=function(e,r){if(e=t.toBuffer(e),r=t.toBuffer(r),e.length===r.length){for(var n=0;n<e.length;n++)if(e[n]!==r[n])return!1;return!0}if(4===r.length){var a=r;r=e,e=a}for(n=0;n<10;n++)if(0!==r[n])return!1;var u=r.readUInt16BE(10);if(0!==u&&65535!==u)return!1;for(n=0;n<4;n++)if(e[n]!==r[n+12])return!1;return!0},t.isPrivate=function(e){return/^(::f{4}:)?10\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(e)||/^(::f{4}:)?192\.168\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(e)||/^(::f{4}:)?172\.(1[6-9]|2\d|30|31)\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(e)||/^(::f{4}:)?127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(e)||/^(::f{4}:)?169\.254\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(e)||/^f[cd][0-9a-f]{2}:/i.test(e)||/^fe80:/i.test(e)||/^::1$/.test(e)||/^::$/.test(e)},t.isPublic=function(e){return!t.isPrivate(e)},t.isLoopback=function(e){return/^(::f{4}:)?127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})/.test(e)||/^fe80::1$/.test(e)||/^::1$/.test(e)||/^::$/.test(e)},t.loopback=function(e){if("ipv4"!==(e=i(e))&&"ipv6"!==e)throw new Error("family must be ipv4 or ipv6");return"ipv4"===e?"127.0.0.1":"fe80::1"},t.address=function(e,r){var a,u=n.networkInterfaces();if(r=i(r),e&&"private"!==e&&"public"!==e){var s=u[e].filter((function(e){return e.family.toLowerCase()===r}));if(0===s.length)return;return s[0].address}return(a=Object.keys(u).map((function(n){var a=u[n].filter((function(n){return n.family=n.family.toLowerCase(),n.family===r&&!t.isLoopback(n.address)&&(!e||("public"===e?t.isPrivate(n.address):t.isPublic(n.address)))}));return a.length?a[0].address:void 0})).filter(Boolean)).length?a[0]:t.loopback(r)},t.toLong=function(e){var t=0;return e.split(".").forEach((function(e){t<<=8,t+=parseInt(e)})),t>>>0},t.fromLong=function(e){return(e>>>24)+"."+(e>>16&255)+"."+(e>>8&255)+"."+(255&e)}}(G);var Y=function(){function e(){E(this,e),this.entity=null,this.collection={}}var t,n,a,u,i,s,o,c,f,l,p,h,d,v;return x(e,[{key:"list",value:(v=S(regeneratorRuntime.mark((function e(){var t,r,n=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.length>0&&void 0!==n[0]?n[0]:{},r=n.length>1&&void 0!==n[1]?n[1]:0,e.prev=2,e.next=5,this.collection.find(t).limit(CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT).skip(r).sort({updated:-1}).toArray();case 5:return e.abrupt("return",e.sent);case 8:return e.prev=8,e.t0=e.catch(2),e.abrupt("return",!1);case 11:case"end":return e.stop()}}),e,this,[[2,8]])}))),function(){return v.apply(this,arguments)})},{key:"find",value:(d=S(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.collection.findOne(t);case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"findByID",value:(h=S(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.find({_id:r.ObjectId(t)});case 3:return n=e.sent,e.abrupt("return",n);case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",!1);case 10:case"end":return e.stop()}}),e,this,[[0,7]])}))),function(e){return h.apply(this,arguments)})},{key:"insert",value:(p=S(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=new Date,e.next=4,this.collection.insertOne(b({updated:r,created:r},t));case 4:return e.next=7,this.find(t);case 7:return e.abrupt("return",e.sent);case 10:return e.prev=10,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",!1);case 14:case"end":return e.stop()}}),e,this,[[0,10]])}))),function(e){return p.apply(this,arguments)})},{key:"insertMany",value:(l=S(regeneratorRuntime.mark((function e(t){var r,n,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=new Date,n=t.map((function(e){return b(b({},e),{},{updated:r,created:r})})),e.next=5,this.collection.insertMany(n);case 5:return a=e.sent,e.abrupt("return",a.ops);case 9:return e.prev=9,e.t0=e.catch(0),e.abrupt("return",!1);case 12:case"end":return e.stop()}}),e,this,[[0,9]])}))),function(e){return l.apply(this,arguments)})},{key:"updateByID",value:(f=S(regeneratorRuntime.mark((function e(t,n){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.update({_id:r.ObjectId(t)},n);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"update",value:(c=S(regeneratorRuntime.mark((function e(t,r){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.collection.updateOne(t,{$set:b({updated:new Date},r)});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"updateMany",value:(o=S(regeneratorRuntime.mark((function e(t,r){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.collection.updateMany(t,{$set:b({updated:new Date},r)});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"delete",value:(s=S(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.collection.deleteOne(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"deleteByID",value:(i=S(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.delete({_id:r.ObjectId(t)});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"deleteMany",value:(u=S(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.collection.deleteMany(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"getLatest",value:(a=S(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.collection.find(t).limit(CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT).sort({$natural:-1}).toArray();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"getOldest",value:(n=S(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.collection.find(t).limit(CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT).sort({$natural:1}).toArray();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"search",value:(t=S(regeneratorRuntime.mark((function e(t){var r,n,a,u,i,s,o,c=this,f=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!(f.length>1&&void 0!==f[1])||f[1],n=q(),a=n.entities,u=[],i=L(a),e.prev=4,o=regeneratorRuntime.mark((function e(){var r,n,a,i,o,f,l;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=s.value,n=r.name,a=r.fields,i=c.db.collection(n),o=Object.keys(a).filter((function(e){var t,r;return[a[e],null===(t=a[e])||void 0===t?void 0:t.type].includes("string")&&!0!==(null===(r=a[e])||void 0===r?void 0:r.secure)})),f={$text:{$diacriticSensitive:!1,$caseSensitive:!1,$search:t}},"string"!=typeof t&&(f=o.reduce((function(e,r){return e[r]=t,e}),{})),e.next=7,i.find(f).toArray();case 7:(l=e.sent).length>0&&u.push(l.map((function(e){return{type:n,record:e}})));case 9:case"end":return e.stop()}}),e)})),i.s();case 7:if((s=i.n()).done){e.next=11;break}return e.delegateYield(o(),"t0",9);case 9:e.next=7;break;case 11:e.next=16;break;case 13:e.prev=13,e.t1=e.catch(4),i.e(e.t1);case 16:return e.prev=16,i.f(),e.finish(16);case 19:if(0!==u.length||!r){e.next=21;break}return e.abrupt("return",this.search(new RegExp(t,"gi"),!1));case 21:return e.abrupt("return",u.flat());case 22:case"end":return e.stop()}}),e,this,[[4,13,16,19]])}))),function(e){return t.apply(this,arguments)})}]),e}(),W=function(e){k(o,Y);var t,n,a,u,i,s=I(o);function o(e){var t,n=e.uri,a=e.name,u=e.key;return E(this,o),(t=s.call(this)).client=new r.MongoClient(n),t.name=a,t.uri=n,t.key=u,t}return x(o,[{key:"createTextIndexes",value:(i=S(regeneratorRuntime.mark((function e(){var t,r,n,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=L(q().entities),e.prev=1,t.s();case 3:if((r=t.n()).done){e.next=15;break}return n=r.value,e.prev=5,a=this.db.collection(n.name),e.next=9,a.createIndex({"$**":"text"},{default_language:CONSTANTS.SERVER.SETTINGS.LANGUAGE.DEFAULT});case 9:e.next=13;break;case 11:e.prev=11,e.t0=e.catch(5);case 13:e.next=3;break;case 15:e.next=20;break;case 17:e.prev=17,e.t1=e.catch(1),t.e(e.t1);case 20:return e.prev=20,t.f(),e.finish(20);case 23:case"end":return e.stop()}}),e,this,[[1,17,20,23],[5,11]])}))),function(){return i.apply(this,arguments)})},{key:"connect",value:(u=S(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.client.connect();case 3:return this.db=this.client.db(this.name),e.next=6,this.createTextIndexes();case 6:return e.abrupt("return",this);case 9:return e.prev=9,e.t0=e.catch(0),console.log(e.t0),e.abrupt("return",e.t0);case 13:case"end":return e.stop()}}),e,this,[[0,9]])}))),function(){return u.apply(this,arguments)})},{key:"setEntity",value:(a=S(regeneratorRuntime.mark((function e(t){var r=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_(S(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.db.createCollection(t);case 2:case"end":return e.stop()}}),e)}))));case 2:this.entity=t,this.collection=this.db.collection(t);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"count",value:(n=S(regeneratorRuntime.mark((function e(){var t,r=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.length>0&&void 0!==r[0]?r[0]:{},e.abrupt("return",this.collection.count(t));case 2:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"validateID",value:(t=S(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.match(/^[0-9a-fA-F]{24}$/));case 1:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})}]),o}(),K={},z=function(){function e(t){E(this,e),this.list=H(t.database),this.databases=K,0===this.list.length&&this.list.push({name:CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT,key:CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT,type:"custom"}),this.setup()}var t;return x(e,[{key:"setup",value:(t=S(regeneratorRuntime.mark((function e(){var t,r,n,a,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=L(this.list),e.prev=1,t.s();case 3:if((r=t.n()).done){e.next=19;break}return n=r.value,e.prev=5,a=this.getClassByType(n.type),u=new a(n),e.next=10,u.connect();case 10:this.databases[n.key]=u,e.next=17;break;case 13:e.prev=13,e.t0=e.catch(5),logger(e.t0),this.databases[n.key]=e.t0;case 17:e.next=3;break;case 19:e.next=24;break;case 21:e.prev=21,e.t1=e.catch(1),t.e(e.t1);case 24:return e.prev=24,t.f(),e.finish(24);case 27:0===Object.keys(this.databases).length&&logger("No databases connected");case 28:case"end":return e.stop()}}),e,this,[[1,21,24,27],[5,13]])}))),function(){return t.apply(this,arguments)})},{key:"getClassByType",value:function(e){switch(e){case"mongo-db":case"mongodb":case"mongoDB":case"mongo":return W;default:return V}}},{key:"getDB",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT;return this.databases[e]}}],[{key:"get",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT;return K[e]}},{key:"closeAll",value:function(e){var t=[];for(var r in K){var n,a;"function"==typeof(null===(n=K[r])||void 0===n||null===(a=n.client)||void 0===a?void 0:a.close)&&(K[r].client.close(),t.push(r))}return t}}]),e}(),X={REQUEST:{BEFORE:{RESPONSE:"REQUEST.BEFORE.RESPONSE",PROCESS:"REQUEST.BEFORE.PROCESS"}}},Z={},ee=function(){function e(t){var r=this;return E(this,e),T(this,"run",S(regeneratorRuntime.mark((function e(){var t,n,a,u,i=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=Z[r.event],!1!==Array.isArray(t)){e.next=3;break}return e.abrupt("return",!1);case 3:n=L(t),e.prev=4,n.s();case 6:if((a=n.n()).done){e.next=22;break}return u=a.value,e.prev=8,e.next=11,Promise.resolve(u.apply(void 0,i));case 11:if(!1!==e.sent){e.next=14;break}return e.abrupt("return",!1);case 14:e.next=20;break;case 16:return e.prev=16,e.t0=e.catch(8),logger(e.t0),e.abrupt("return",!1);case 20:e.next=6;break;case 22:e.next=27;break;case 24:e.prev=24,e.t1=e.catch(4),n.e(e.t1);case 27:return e.prev=27,n.f(),e.finish(27);case 30:return e.abrupt("return",!0);case 31:case"end":return e.stop()}}),e,null,[[4,24,27,30],[8,16]])})))),this.event=t,!1===Array.isArray(Z[t])&&(Z[t]=[]),this}return x(e,[{key:"set",value:function(t){return e.setListener(this.event,t)}},{key:"remove",value:function(t){return e.removeListener(this.event,t)}}],[{key:"setListener",value:function(e,t){return Z[e].push(t)-1}},{key:"removeListener",value:function(e,t){try{Z[e].filter((function(e,r){return t!==r}));return!0}catch(e){return!1}}}]),e}();function te(e,t){var r=t.fields,n=Object.keys(r).map((function(e){var t,n;return{type:(null===(t=r[e])||void 0===t?void 0:t.type)||y(r[e]),required:!(null===(n=r[e])||void 0===n||!n.required),key:e}})).filter((function(e){return e.required})).reduce((function(e,t){return t.required&&(e[t.key]=t.type),e}),{});for(var a in n)if(y(e[a])!==n[a])return!1;return!0}function re(e){return e.splitted[1]}var ne=function(e,t){return function(r){var n=r.url.splitted.filter((function(e){return e.length>0}));return r.method===CONSTANTS.SERVER.METHODS[e]&&t(n.length)}},ae={delete:ne("DELETE",(function(e){return 2===e})),update:ne("UPDATE",(function(e){return 2===e})),insert:ne("INSERT",(function(e){return 1===e})),list:ne("LIST",(function(e){return 1===e})),get:ne("GET",(function(e){return 2===e})),oldest:function(e){return e.url.value.search("oldest")>-1&&e.method===CONSTANTS.SERVER.METHODS.GET},latest:function(e){return e.url.value.search("latest")>-1&&e.method===CONSTANTS.SERVER.METHODS.GET}},ue=function(){function e(t,r){var n=this;E(this,e),T(this,"next",(function(e){return{response:n.response,code:e}})),T(this,"validateURL",S(regeneratorRuntime.mark((function e(){var t,r,a,u,i,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,t=q(),r=D(n.request.url.splitted,1),a=r[0],u=L(t.entities),e.prev=4,u.s();case 6:if((i=u.n()).done){e.next=16;break}if(s=i.value,!(a===s.name)){e.next=14;break}return n.entity=s,e.next=13,n.database.setEntity(s.name);case 13:return e.abrupt("return",200);case 14:e.next=6;break;case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(4),u.e(e.t0);case 21:return e.prev=21,u.f(),e.finish(21);case 24:return e.abrupt("return",404);case 27:return e.prev=27,e.t1=e.catch(0),logger(e.t1),e.abrupt("return",500);case 31:case"end":return e.stop()}}),e,null,[[0,27],[4,18,21,24]])})))),T(this,"action",S(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!ae.oldest(n.request)){e.next=4;break}return e.next=3,n.oldest();case 3:case 7:case 11:case 15:case 19:case 23:case 27:return e.abrupt("return",e.sent);case 4:if(!ae.latest(n.request)){e.next=8;break}return e.next=7,n.latest();case 8:if(!ae.update(n.request)){e.next=12;break}return e.next=11,n.update();case 12:if(!ae.delete(n.request)){e.next=16;break}return e.next=15,n.delete();case 16:if(!ae.insert(n.request)){e.next=20;break}return e.next=19,n.insert();case 20:if(!ae.list(n.request)){e.next=24;break}return e.next=23,n.list();case 24:if(!ae.get(n.request)){e.next=28;break}return e.next=27,n.get();case 28:return e.abrupt("return",n.next(404));case 29:case"end":return e.stop()}}),e)})))),T(this,"list",S(regeneratorRuntime.mark((function e(){var t,r,a,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Promise.all([n.database.list(),n.database.count()]);case 3:return t=e.sent,r=D(t,2),a=r[0],u=r[1],n.response={records:a,count:u},e.abrupt("return",n.next(200));case 11:return e.prev=11,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",n.next(500));case 15:case"end":return e.stop()}}),e,null,[[0,11]])})))),T(this,"get",S(regeneratorRuntime.mark((function e(){var t,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=n.request.url.splitted[1]+"",!1!==n.database.validateID(t)){e.next=4;break}return e.abrupt("return",n.next(404));case 4:return e.next=6,n.database.findByID(t);case 6:if(!1!==(r=e.sent)){e.next=9;break}return e.abrupt("return",n.next(204));case 9:return n.response=T({},n.entity.name,r),e.abrupt("return",n.next(200));case 13:return e.prev=13,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",n.next(500));case 17:case"end":return e.stop()}}),e,null,[[0,13]])})))),T(this,"insert",S(regeneratorRuntime.mark((function e(){var t,r,a,u,i,s,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,t=n.request.body,r=!1===Array.isArray(t)?[t]:t,a=[],u=L(r),e.prev=5,u.s();case 7:if((i=u.n()).done){e.next=20;break}if(s=i.value,!1!==te(s,n.entity)){e.next=14;break}a.push(400),e.next=18;break;case 14:return e.next=16,n.database.insert(s);case 16:o=e.sent,a.push(!1===o?500:o);case 18:e.next=7;break;case 20:e.next=25;break;case 22:e.prev=22,e.t0=e.catch(5),u.e(e.t0);case 25:return e.prev=25,u.f(),e.finish(25);case 28:if(!a.includes(400)){e.next=30;break}return e.abrupt("return",n.next(400));case 30:if(!a.includes(400)){e.next=32;break}return e.abrupt("return",n.next(500));case 32:return n.response=T({},n.entity.name,1===r.length?a[0]:a),e.abrupt("return",n.next(200));case 36:return e.prev=36,e.t1=e.catch(0),logger(e.t1),e.abrupt("return",n.next(500));case 40:case"end":return e.stop()}}),e,null,[[0,36],[5,22,25,28]])})))),T(this,"delete",S(regeneratorRuntime.mark((function e(){var t,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=re(n.request.url),!1!==n.database.validateID(t)){e.next=4;break}return e.abrupt("return",n.next(400));case 4:return e.next=6,n.database.deleteByID(t);case 6:if(!((null==(r=e.sent)?void 0:r.deletedCount)>0)){e.next=9;break}return e.abrupt("return",n.next(200));case 9:return n.response={message:"0 records deleted"},e.abrupt("return",n.next(200));case 13:return e.prev=13,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",n.next(500));case 17:case"end":return e.stop()}}),e,null,[[0,13]])})))),T(this,"update",S(regeneratorRuntime.mark((function e(){var t,r,a,u,i,s,o,c,f;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=re(n.request.url),r=n.request.body,!1!==n.database.validateID(t)){e.next=5;break}return e.abrupt("return",n.next(400));case 5:for(a=Object.keys(n.entity.fields),u={},i=0,s=a;i<s.length;i++)o=s[i],r[o]&&(u[o]=r[o]);if(!(Object.keys(u).length<1)){e.next=10;break}return e.abrupt("return",n.next(400));case 10:return e.next=12,n.database.updateByID(t,u);case 12:if(!((null==(c=e.sent)?void 0:c.modifiedCount)<1)){e.next=16;break}return n.response={message:"No records updated"},e.abrupt("return",n.next(500));case 16:return e.next=18,n.database.findByID(t);case 18:return!1!==(f=e.sent)&&(n.response=T({},n.entity.name,f)),e.abrupt("return",n.next(200));case 23:return e.prev=23,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",n.next(500));case 27:case"end":return e.stop()}}),e,null,[[0,23]])})))),T(this,"oldest",S(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n.database.getOldest();case 3:return t=e.sent,n.response=T({},n.entity.name,t),e.abrupt("return",n.next(200));case 8:return e.prev=8,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",n.next(500));case 12:case"end":return e.stop()}}),e,null,[[0,8]])})))),T(this,"latest",S(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n.database.getLatest();case 3:return t=e.sent,n.response=T({},n.entity.name,t),e.abrupt("return",n.next(200));case 8:return e.prev=8,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",n.next(500));case 12:case"end":return e.stop()}}),e,null,[[0,8]])})))),this.request=t,this.response=null,this.entity={},this.database=z.get(r)}var t;return x(e,[{key:"run",value:(t=S(regeneratorRuntime.mark((function e(){var t,r,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.request,r=t.method,e.next=3,this.validateURL();case 3:if(n=e.sent,!1!==Object.values(CONSTANTS.SERVER.METHODS).includes(r)){e.next=7;break}return e.abrupt("return",this.next(404));case 7:if(200===n){e.next=9;break}return e.abrupt("return",this.next(n));case 9:return e.next=11,this.action();case 11:return e.abrupt("return",e.sent);case 12:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),e}(),ie=function(){function e(){E(this,e)}return x(e,null,[{key:"handle",value:function(e,t){return new ue(e,t).run()}}]),e}(),se={200:{code:200,message:"OK"},204:{code:204,message:"No Content"},400:{code:400,message:"Bad Request"},401:{code:401,message:"Unauthorized"},403:{code:403,message:"Requested Resource Is Forbidden"},404:{code:404,message:"Not Found"},405:{code:405,message:"Method Not Allowed"},422:{code:422,message:"Unprocessable Entity"},429:{code:429,message:"Too Many Requests"},500:{code:500,message:"Server Error"}},oe=function(){function e(){E(this,e)}return x(e,null,[{key:"get",value:function(e){return b({status:200===e},se[e])}}]),e}();function ce(e){return JSON.stringify(e)}function fe(e){var t;return!0===Array.isArray(e)?(t=e[0],e):(t=e,[e]),[t=Object.keys(t).join(","),e.map((function(e){return Object.values(e).join(",")})).join("\n")].join("\n")}function le(e){var t=[CONSTANTS.SERVER.METHODS.INSERT,CONSTANTS.SERVER.METHODS.UPDATE];return new Promise((function(r,n){var a="";if(!1===t.includes(e.method))return r({});e.on("data",(function(e){a+=e})),e.on("end",(function(){return r(JSON.parse(a))})),e.on("error",(function(e){return n(e)}))}))}var pe,he,de=function(){function e(t){var r=this,n=t.format,a=t.port,u=t.type,i=t.database;return E(this,e),T(this,"handler",function(){var e=S(regeneratorRuntime.mark((function e(t,n){var a,u,i,s,o,c;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,le(t);case 3:t.body=e.sent,e.next=9;break;case 6:return e.prev=6,e.t0=e.catch(0),e.abrupt("return",r.parse(422));case 9:if(r.res=n,r.req=t,r.res.json=function(e){return r.res.payload=b(b({},oe.get(200)),e),!0},r.req.server={database:r.database,format:r.format,type:r.type,port:r.port},logger(t.method+" "+t.url),!(t.url.split(".").length>1)){e.next=17;break}return e.abrupt("return",r.handleNotFound());case 17:a=[new ee(X.REQUEST.BEFORE.PROCESS),new M],u=0,i=a;case 19:if(!(u<i.length)){e.next=30;break}return s=i[u],e.next=23,s.run(r.req,r.res);case 23:if(o=e.sent,!(!1!==o||200!==r.res.statusCode||"object"===y(r.res.payload))){e.next=27;break}return e.abrupt("return",r.parse(r.res.statusCode,b(b({},oe.get(r.res.statusCode)),r.res.payload)));case 27:u++,e.next=19;break;case 30:return e.next=32,ie.handle(r.req,r.database);case 32:if(200!==(c=e.sent).code){e.next=35;break}return e.abrupt("return",r.parse(c.code,c.response));case 35:if(404===c.code){e.next=37;break}return e.abrupt("return",r.parse(c.code,oe.get(c.code)));case 37:return e.abrupt("return",r.handleNotFound());case 38:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(t,r){return e.apply(this,arguments)}}()),this.database=i,this.format=n,this.type=u,this.port=a,this.handler}return x(e,[{key:"parse",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};switch(this.code=e,this.response=b(b({},oe.get(e)),t),this.format){case CONSTANTS.SERVER.FORMATS.CSV:this.res.setHeader("Content-Type","text/csv"),this.res.setHeader("Content-Disposition","attachment;filename=response.csv"),this.response=fe(t);break;case CONSTANTS.SERVER.FORMATS.JSON:default:this.res.setHeader("Content-Type","application/json"),this.response=ce(this.response)}return this.send()}},{key:"handleNotFound",value:function(){return this.parse(404,oe.get(404))}},{key:"send",value:function(){this.res.writeHead(this.code),this.res.end(this.response)}}]),e}(),ve=x((function e(t){var r=this;E(this,e);var n=t.port;return t.type,t.format,this.port=n,this.host=G.address(),this.app=h.default.createServer(new de(t)),this.app.listen(this.port,this.host,(function(){logger("Server running on http://".concat(r.host,":").concat(r.port))})),this})),ge=function(){function e(t){t.entity;var r=t.server;E(this,e),pe=CONSTANTS.SERVER.SETTINGS.DATABASE.AUTH,he=CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT,this.server=r,this.database=z.get((null==r?void 0:r.database)||he),this.database.setEntity(pe)}var t,r;return x(e,[{key:"validate",value:(r=S(regeneratorRuntime.mark((function e(t){var r,n,a,u,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.database.setEntity(pe);case 3:return e.next=5,this.database.find({token:t});case 5:if((n=e.sent).entity){e.next=8;break}return e.abrupt("return",[!1,!1]);case 8:return a=z.get((null===(r=this.server)||void 0===r?void 0:r.database)||he),e.next=11,a.setEntity(n.entity.type);case 11:return e.next=13,a.findByID(n.entity.id);case 13:return u=e.sent,e.next=16,this.database.setEntity(pe);case 16:return i=q().entities.find((function(e){return e.name===n.entity.type})),e.abrupt("return",[J(u,i),n.entity.type]);case 20:return e.prev=20,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",!1);case 24:case"end":return e.stop()}}),e,this,[[0,20]])}))),function(e){return r.apply(this,arguments)})},{key:"register",value:(t=S(regeneratorRuntime.mark((function e(t,r,n){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.database.setEntity(pe);case 3:return e.next=5,this.database.insert({token:n,entity:{type:r,id:t}});case 5:return e.abrupt("return",!0);case 9:return e.prev=9,e.t0=e.catch(0),logger(e.t0),e.abrupt("return",!1);case 13:case"end":return e.stop()}}),e,this,[[0,9]])}))),function(e,r,n){return t.apply(this,arguments)})},{key:"generate",value:function(){return v.default.randomBytes(64).toString("hex")}}]),e}(),be={TYPES:{OATH:"oauth",JWT:"jwt"},ROUTES:{LOGIN:["POST","/system/auth"]},PERMISSIONS:{INSERT:"insert",UPDATE:"update",DELETE:"delete",LIST:"list",GET:"get"},PERMISSIONS_BY_METHODS:{POST:["insert"],PATCH:["update"],DELETE:["delete"],LIST:["list"],GET:["get"]}};Object.values(be.ROUTES).map((function(e){return e.PATH}));var ye=D(be.ROUTES.LOGIN,2),me=ye[0],Se=ye[1];(new M).use(me,Se,function(){var e=S(regeneratorRuntime.mark((function e(t,r){var n,a,u,i,s,o,c,f,l,p,h,v,g,b,m;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=z.get(t.server.database),a=CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT,e.prev=2,c=null,f=null,l=L(q().entities),e.prev=6,h=regeneratorRuntime.mark((function e(){var r,a,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("object"!==y((r=p.value).auth)){e.next=9;break}return e.next=4,n.setEntity(r.name);case 4:return a=Object.keys(t.body).reduce((function(e,n){var a,u;return null!=r&&null!==(a=r.auth)&&void 0!==a&&null!==(u=a.fields)&&void 0!==u&&u.includes(n)&&(e[n]=t.body[n]),e}),{}),e.next=7,n.find(a);case 7:(u=e.sent)&&Object.keys(u).length>0&&(c=u,f=r);case 9:case"end":return e.stop()}}),e)})),l.s();case 9:if((p=l.n()).done){e.next=13;break}return e.delegateYield(h(),"t0",11);case 11:e.next=9;break;case 13:e.next=18;break;case 15:e.prev=15,e.t1=e.catch(6),l.e(e.t1);case 18:return e.prev=18,l.f(),e.finish(18);case 21:if(c&&f){e.next=23;break}return e.abrupt("return",r.statusCode=401);case 23:return null!==(u=f)&&void 0!==u&&null!==(i=u.auth)&&void 0!==i&&i.secret&&(a=f.auth.secret),v=new ge(t),g=$(c),b=v.generate(),m="jwt"!==(null===(s=f)||void 0===s||null===(o=s.auth)||void 0===o?void 0:o.type)?b:d.default.sign({access:b,id:g},a),e.next=30,v.register(g,f.name,m);case 30:return r.setHeader("x-auth-token",m),e.abrupt("return",r.json(T({},f.name,J(c,f))));case 34:e.prev=34,e.t2=e.catch(2),logger(e.t2),r.statusCode=500;case 38:return e.abrupt("return",!1);case 39:case"end":return e.stop()}}),e,null,[[2,34],[6,15,18,21]])})));return function(t,r){return e.apply(this,arguments)}}()),new ee(X.REQUEST.BEFORE.PROCESS).set(function(){var e=S(regeneratorRuntime.mark((function e(t,r){var n,a,u,i,s,o,c,f,l,p,h,d,v,g,b;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=q(),a=n.entities,u=t.url.split("/"),i=t.url.split("?"),s=D(i,2),o=s[0],c=void 0===o?"":o,f=s[1],l=void 0===f?"":f,r.send=function(e){return t.paload=e,!0},r.error=function(e){return t.statusCode=e,!0},t.url={value:t.url,base:c,splitted:u.filter((function(e){return e.length>0})),params:l.split("&").reduce((function(e,t){var r=D(t.split("="),2),n=r[0],a=r[1];return e[n]=a,e}),{})},t.entity=a.find((function(e){return e.name===t.url.splitted[0]}))||!1,void 0!==(p=t.headers["x-auth-token"])){e.next=10;break}return e.abrupt("return",!0);case 10:if(!M.inWhitelist(t)){e.next=12;break}return e.abrupt("return",!0);case 12:return h=new ge(t),e.next=15,h.validate(p);case 15:d=e.sent,v=D(d,2),g=v[0],b=v[1],t.auth=g,t.entity=a.find((function(e){return e.name===b}))||!1;case 21:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}());var Ee=function(e,t){return function(r){var n=r.url.splitted.filter((function(e){return e.length>0}));return r.method===CONSTANTS.SERVER.METHODS[e]&&t(n.length)}},Re={delete:Ee("DELETE",(function(e){return 2===e})),update:Ee("UPDATE",(function(e){return 2===e})),insert:Ee("INSERT",(function(e){return 1===e})),list:Ee("LIST",(function(e){return 1===e})),get:Ee("GET",(function(e){return 2===e})),oldest:function(e){return e.url.value.search("oldest")>-1&&e.method===CONSTANTS.SERVER.METHODS.GET},latest:function(e){return e.url.value.search("latest")>-1&&e.method===CONSTANTS.SERVER.METHODS.GET}};new ee(X.REQUEST.BEFORE.PROCESS).set(function(){var e=S(regeneratorRuntime.mark((function e(t,r){var n,a,u,i,s,o,c,f,l,p,h,d,v,g,b,m,S,E,R,x,T,k,w;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(u=CONSTANTS.SERVER.AUTH,i=u.PERMISSIONS,s=u.PERMISSIONS_BY_METHODS,o={oldest:i.LIST,latest:i.LIST,update:i.UPDATE,delete:i.DELETE,insert:i.INSERT,list:i.LIST,get:i.GET},!1!==q().entities.filter((function(e){return"object"===y(e.auth)})).length>0){e.next=5;break}return e.abrupt("return",!1);case 5:if(c=null===(n=Object.keys((null==t||null===(a=t.entity)||void 0===a?void 0:a.permission)||{}))||void 0===n?void 0:n.filter((function(e){var r;return!0===(null===(r=t.entity)||void 0===r?void 0:r.permission[e])})),f=!(null==c||!c.find((function(e){return s[t.method].includes(e)}))),!f){e.next=9;break}return e.abrupt("return",!1);case 9:l=0,p=Object.keys(Re);case 10:if(!(l<p.length)){e.next=24;break}if(h=p[l],!Re[h](t)){e.next=21;break}if(!(g=null===(d=t.entity)||void 0===d||null===(v=d.auth)||void 0===v?void 0:v.permission)){e.next=21;break}if(b=o[h]||i.LIST,m=g[t.entity.name]||g["*"],S=!!t.auth,!!!m[b]||!S){e.next=21;break}return e.abrupt("return",!1);case 21:l++,e.next=10;break;case 24:E=L(M.getRequests()),e.prev=25,E.s();case 27:if((R=E.n()).done){e.next=36;break}if(x=R.value,T=x.path,k=x.method,w=x.options,T!==t.url.base||k!==t.method){e.next=34;break}if(!0!==w.public){e.next=32;break}return e.abrupt("return",!1);case 32:if(!1!==w.public||!t.auth){e.next=34;break}return e.abrupt("return",!1);case 34:e.next=27;break;case 36:e.next=41;break;case 38:e.prev=38,e.t0=e.catch(25),E.e(e.t0);case 41:return e.prev=41,E.f(),e.finish(41);case 44:return r.statusCode=401,e.abrupt("return",!0);case 46:case"end":return e.stop()}}),e,null,[[25,38,41,44]])})));return function(t,r){return e.apply(this,arguments)}}());var xe={SEARCH:["GET","/system/search"],SYSTEM:["GET","/system"],HOME:["GET","/"]},Te=D(xe.SEARCH,2),ke=Te[0],we=Te[1];(new M).use(ke,we,{public:!1},function(){var e=S(regeneratorRuntime.mark((function e(t,r){var n,a,u,i,s,o,c,f;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==Object.keys(t.url.params).length){e.next=2;break}return e.abrupt("return",r.error(422));case 2:return n=t.url.params,a=n.query,u=n.search,i=n.s,s=n.q,o=a||u||i||s,c=z.get(t.server.database),e.next=7,c.setEntity(t.entity.name);case 7:return e.next=9,c.search(o);case 9:return f=e.sent,e.abrupt("return",r.json({records:f}));case 11:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}());for(var Oe=new M,Ae=function(){var e=S(regeneratorRuntime.mark((function e(t,r){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r.json({message:"API Running"}));case 1:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),Ne=0,Ie=[xe.HOME,xe.SYSTEM];Ne<Ie.length;Ne++){var De=D(Ie[Ne],2),je=De[0],Ce=De[1];Oe.use(je,Ce,Ae)}var Le=function(){function e(t){var r=t.config;E(this,e),this.servers=[];var n,a=L(H(r));try{for(a.s();!(n=a.n()).done;){var u=n.value;if(u.type===CONSTANTS.SERVER.TYPES.REST){var i=new ve(this.getConfigData(u));this.servers.push(i)}}}catch(e){a.e(e)}finally{a.f()}return this.servers}return x(e,[{key:"getConfigData",value:function(e){var t=D(H(q().database),1)[0],r=b({},e);return r.database||(r.database=t.key||CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT),r}}]),e}();global.CONSTANTS={SERVER:{METHODS:{INSERT:"POST",UPDATE:"PATCH",DELETE:"DELETE",LIST:"GET",GET:"GET",POST:"POST",PATCH:"PATCH"},EVENTS:X,AUTH:be,SECRET:"DEFAUL-SECRET-JSON-SERVER",TYPES:{REST:"rest",SOCKET:"socket"},FORMATS:{JSON:"json",CSV:"csv"},SETTINGS:{DATABASE:{DEFAULT:"custom-db",AUTH:"json-server-auth"},REQUEST:{LIMIT:10},LANGUAGE:{DEFAULT:"pt"}}}};var Pe=function(){function e(t){E(this,e),this.json=t,this.name=t.name,this.routes=new M,global["json-server"]=t,global.logger=t.logger||console.log}var t;return x(e,[{key:"setup",value:function(e){var t=e.request,r=e.database,n=e.language;t.limit&&(CONSTANTS.SERVER.SETTINGS.REQUEST.LIMIT=t.limit),null!=r&&r.default&&(CONSTANTS.SERVER.SETTINGS.DATABASE.DEFAULT=r.default),n&&(CONSTANTS.SETTINGS.LANGUAGE.DEFAULT=n)}},{key:"run",value:(t=S(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{this.databases=new z(this.json),this.servers=new Le(this.json)}catch(e){logger(e)}case 1:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"getServerByPort",value:function(e){return this.servers.find((function(t){return t.port===e}))}}]),e}();module.exports=Pe;
